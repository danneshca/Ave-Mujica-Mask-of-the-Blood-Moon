<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ave Mujica: Mask of the Blood Moon</title>
  <style>
    :root {
      --bg:#0b0b0d; --red:#b11226; --gold:#c8a75a; --ink:#e4d7b7; --panel:#121216; --accent:#7a0c17;
      --ok:#69d392; --warn:#ffce6b; --bad:#ff6b6b;
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: "Cinzel Decorative", serif; }
    /* ç»“æ„å¸ƒå±€ */
    #app { display:flex; flex-direction:column; min-height:100vh; }
    header { padding:10px 16px; border-bottom:1px solid #222; background:linear-gradient(180deg, #0e0e11 0%, #0a0a0c 100%); position:relative; display:flex; align-items:center; gap:12px; }
    header .logo { height:50px; width:auto; filter:drop-shadow(0 0 8px rgba(200,167,90,0.3)); }
    header .title-section { flex:1; }
    header h1 { margin:0; font-weight:600; letter-spacing:1px; color:var(--gold); }

    main { flex:1; display:grid; grid-template-columns: 280px 1fr 300px; gap:12px; padding:12px; }
    .panel { background:var(--panel); border:1px solid #222; border-radius:8px; overflow:hidden; }
    .panel h2 { margin:0; padding:8px 10px; font-size:14px; letter-spacing:1px; background:#0f0f12; color:var(--gold); border-bottom:1px solid #1e1e22; }
    .content { padding:10px; }


    /* é¡¶éƒ¨è¡€æœˆè£…é¥° */
    .bloodmoon-wrap { position:absolute; right:12px; top:8px; width:40px; height:40px; }
    .bloodmoon { width:100%; height:100%; border-radius:50%; background: radial-gradient(closest-side, var(--red), #3a0b10 60%, transparent 65%);
      box-shadow: 0 0 12px 2px rgba(177,18,38,.7), inset 0 0 16px rgba(255,255,255,.05);
      animation: moonPulse 2.8s infinite;
    }
    @keyframes moonPulse { 0%, 100% { filter:brightness(1) } 50% { filter:brightness(1.25) saturate(1.15) } }

    /* é¢å…·ç¢è£‚åŠ¨ç”»ï¼ˆSVG è£…é¥°ï¼‰ */
    .mask { width:100%; height:140px; position:relative; }
    .mask svg { width:100%; height:100%; }
    .piece { transition: transform .6s ease, opacity .6s ease; }
    .mask.break .piece { transform: translateY(6px) rotate(2deg); opacity:.85; }

    /* è§’è‰²ç«‹ç»˜æ ·å¼ */
    .character-portrait { 
      width:100%; 
      max-width:200px; 
      height:auto; 
      border-radius:8px; 
      border:2px solid var(--gold); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.6), 0 0 20px rgba(200,167,90,0.2); 
      filter: sepia(0.1) contrast(1.1) brightness(0.95);
      transition: all 0.3s ease;
      margin: 10px 0;
    }
    .character-portrait:hover { 
      transform: scale(1.02); 
      box-shadow: 0 6px 16px rgba(0,0,0,0.8), 0 0 25px rgba(200,167,90,0.3); 
    }

    /* æ•Œäººç«‹ç»˜æ ·å¼ */
    .enemy-portrait { 
      width:100%; 
      max-width:180px; 
      height:auto; 
      border-radius:8px; 
      border:2px solid var(--red); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.6), 0 0 20px rgba(177,18,38,0.3); 
      filter: sepia(0.2) contrast(1.15) brightness(0.9) hue-rotate(10deg);
      transition: all 0.3s ease;
      margin: 10px auto;
      display: none;
    }
    .enemy-portrait.show { 
      display: block; 
      animation: enemyAppear 0.6s ease-out;
    }
    .enemy-portrait:hover { 
      transform: scale(1.02); 
      box-shadow: 0 6px 16px rgba(0,0,0,0.8), 0 0 25px rgba(177,18,38,0.4); 
    }
    @keyframes enemyAppear {
      from { opacity: 0; transform: translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    /* æŠ€èƒ½ä¸æŒ‰é’® */
    .cards { display:flex; flex-wrap:wrap; gap:8px; }
    .skill { background:linear-gradient(135deg, #1a1a1d 0%, #0e0e11 100%); border:1px solid #333; border-radius:6px; padding:8px; width:140px; min-height:160px; cursor:pointer; transition:all .2s; position:relative; }
    .skill:hover { border-color:var(--gold); transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.4); }
    .skill.disabled { opacity:0.5; cursor:not-allowed; border-color:#555; }
    .skill.disabled:hover { transform:none; box-shadow:none; border-color:#555; }
    .skill .name { font-weight:600; color:var(--gold); margin-bottom:4px; font-size:13px; }
    .skill .cost { font-size:10px; color:var(--red); margin-bottom:4px; }
    .skill .type { font-size:9px; color:#888; margin-bottom:4px; text-transform:uppercase; }
    .skill .status { font-size:10px; color:#ff6b6b; margin-bottom:4px; font-weight:500; }
    .skill .desc { font-size:11px; line-height:1.3; color:#ccc; }

    .actions { display:flex; flex-wrap:wrap; gap:8px; }
    button { background:linear-gradient(180deg, #1a1214, #0e0a0b); border:1px solid #3a0b10; color:#ffd7de; padding:8px 10px; border-radius:6px; cursor:pointer; }
    button:hover { filter: brightness(1.1); }
    .choice { display:flex; gap:8px; }

    /* HUD */
    .hud { display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; }
    .stat { background:#0e0e12; padding:6px 8px; border:1px solid #1d1d22; border-radius:6px; font-size:12px; }
    .good { color:var(--ok) } .warn { color:var(--warn) } .bad { color:var(--bad) }

    /* å™äº‹ */
    .story { font-size:13px; line-height:1.6; color:#d9d3c6; }
    .story em { color:var(--gold) }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
      header { flex-direction: column; text-align: center; gap: 8px; }
      header .logo { height: 40px; }
      .character-portrait, .enemy-portrait { max-width: 150px; }
    }
    @media (max-width: 600px) {
      header .logo { height: 35px; }
      .character-portrait, .enemy-portrait { max-width: 120px; }
      .cards { justify-content: center; }
      .card { width: 110px; min-height: 140px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <img src="pic/logo_avemujica_å‰¯æœ¬.png" alt="Ave Mujica Logo" class="logo">
      <div class="title-section">
        <h1>Ave Mujica: Mask of the Blood Moon</h1>
      </div>
      <div class="bloodmoon-wrap"><div id="bloodmoon" class="bloodmoon"></div></div>
    </header>
    <main>
      <section class="panel" id="left">
        <h2>å‰§åœº / é¢å…·</h2>
        <div class="content">
          <div class="mask" id="mask">
            <svg viewBox="0 0 300 140">
              <path class="piece" fill="#f0e6d0" d="M40,20 C120,-10 180,-10 260,20 C240,80 60,80 40,20" />
              <circle class="piece" cx="110" cy="60" r="8" fill="#0b0b0d"/>
              <circle class="piece" cx="190" cy="60" r="8" fill="#0b0b0d"/>
              <path class="piece" d="M100,95 Q150,115 200,95" stroke="#c8a75a" stroke-width="3" fill="none"/>
            </svg>
          </div>
          <img id="characterPortrait" class="character-portrait" src="pic/Doloris.png" alt="Character Portrait">
          <div id="story" class="story"></div>
          <div class="actions" id="actions"></div>
        </div>
      </section>

      <section class="panel" id="center">
        <h2>æˆ˜åœº / å¡ç‰Œ</h2>
        <div class="content">
          <div class="hud" id="hud"></div>
          <img id="enemyPortrait" class="enemy-portrait" src="pic/Timoris.png" alt="Enemy Portrait">
          <div class="cards" id="hand"></div>
          <div class="actions" id="combatActions"></div>
        </div>
      </section>

      <section class="panel" id="right">
        <h2>åœ°å›¾ / é—ç‰©</h2>
        <div class="content">
          <div id="map"></div>
          <hr style="border-color:#222;" />
          <div id="relics"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ===== æ ¸å¿ƒå·¥å…· =====
  const rng = { seed: Date.now() % 2147483647, next() { this.seed = (this.seed * 48271) % 2147483647; return this.seed / 2147483647; }, int(a,b){ return a + Math.floor(this.next()*(b-a+1)); } };
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const safeNum = v => (Number.isFinite(v) ? v : 0);
  const el = sel => document.querySelector(sel);
  const make = (tag, props={}) => { const e = document.createElement(tag); Object.assign(e, props); return e; };

  // ===== æ¸¸æˆçŠ¶æ€ =====
  const game = {
    state: 'intro', // intro -> map -> event/combat -> resolve -> nextFloor -> boss/end
    floor: 1, maxFloor: 7,
    moonPhase: 0, // 0~3 æ–°/ä¸Š/æ»¡/ä¸‹ æˆ– 'blood'è¡€æœˆ
    player: { 
      name:'Doloris', hp: 80, maxHp:80, block:0, energy:3, maxEnergy:3, 
      madness:0, // ç‹‚æ°”å€¼ 0-10
      corruption:0, // å •è½åº¦ 0-5
      currentMask: 'doloris', // å½“å‰é¢å…·
      skills: [], // æ‹¥æœ‰çš„æŠ€èƒ½IDåˆ—è¡¨
      skillCooldowns: {}, // æŠ€èƒ½å†·å´çŠ¶æ€ {skillId: remainingTurns}
      skillUses: {}, // æŠ€èƒ½ä½¿ç”¨æ¬¡æ•° {skillId: usedCount}
      nextAttackDouble: false, // ä¸‹æ¬¡æ”»å‡»ä¼¤å®³ç¿»å€
      enhancedTurns: 0, // æŠ€èƒ½å¢å¼ºå›åˆæ•°
      relics: [] 
    },
    enemy: null,
    lorePages: [],
    endings: [],
    bossDefeated:false,
  };

  // ===== Ave Mujica ä¸–ç•Œè§‚æŠ€èƒ½ç³»ç»Ÿ =====
  
  // æœˆç›¸ç³»ç»Ÿ
  const MOON_PHASES = ['æ–°æœˆ', 'ä¸Šå¼¦', 'æ»¡æœˆ', 'ä¸‹å¼¦'];
  
  // é¢å…·ç³»ç»Ÿ
  const MASKS = {
    doloris: { name: 'Dolorisé¢å…·', desc: 'å¹³è¡¡å‹ï¼Œå¯åˆ‡æ¢å…¶ä»–é¢å…·', color: '#FFD700' },
    mortis: { name: 'Mortisé¢å…·', desc: 'æ­»äº¡ç³»æŠ€èƒ½å¢å¼º', color: '#8B0000' },
    amoris: { name: 'Amorisé¢å…·', desc: 'é­…æƒ‘ç³»æŠ€èƒ½å¢å¼º', color: '#FF69B4' },
    timoris: { name: 'Timorisé¢å…·', desc: 'ææƒ§ç³»æŠ€èƒ½å¢å¼º', color: '#4B0082' },
    oblivionis: { name: 'Oblivionisé¢å…·', desc: 'é—å¿˜ç³»æŠ€èƒ½å¢å¼º', color: '#2F4F4F' }
  };

  const SKILL_DB = [
    // === Doloris åŸºç¡€æŠ€èƒ½ ===
    { id:'shadowStrike', name:'æš—å½±ä¸€å‡»', cost:1, cooldown:0, maxUses:0, desc:'é€ æˆ 8 ä¼¤å®³ã€‚åŸºç¡€æ”»å‡»ã€‚', type:'attack', character:'doloris', play:(ctx)=> dmg(ctx, 8) },
    { id:'maskShift', name:'é¢å…·è½¬æ¢', cost:1, cooldown:1, maxUses:0, desc:'åˆ‡æ¢é¢å…·ï¼Œè·å¾— 8 æ ¼æŒ¡ã€‚', type:'special', character:'doloris', play:(ctx)=> { changeMask(ctx); gainBlock(ctx, 8); } },
    { id:'moonRitual', name:'æœˆç›¸ä»ªå¼', cost:2, cooldown:2, maxUses:0, desc:'æ”¹å˜æœˆç›¸ï¼Œæ ¹æ®æ–°æœˆç›¸è·å¾—ä¸åŒæ•ˆæœã€‚', type:'ritual', character:'doloris', play:(ctx)=> changeMoonPhase(ctx) },
    
    // === Mortis æ­»äº¡ç³»æŠ€èƒ½ ===
    { id:'deathTouch', name:'æ­»äº¡ä¹‹è§¦', cost:2, cooldown:1, maxUses:0, desc:'é€ æˆ 10 ä¼¤å®³ã€‚æ»¡æœˆæ—¶+4ä¼¤å®³ã€‚', type:'attack', character:'mortis', play:(ctx)=> { 
      let dmg_val = 10; 
      if(game.moonPhase === 2) dmg_val += 4; 
      dmg(ctx, dmg_val); 
    }},
    { id:'soulDrain', name:'çµé­‚æ±²å–', cost:2, cooldown:2, maxUses:0, desc:'é€ æˆ 8 ä¼¤å®³ï¼Œå›å¤ç­‰é‡ç”Ÿå‘½ã€‚æ¶ˆè€— 1 ç‹‚æ°”å€¼å¢å¼ºæ•ˆæœã€‚', type:'attack', character:'mortis', play:(ctx)=> { 
      let dmg_val = 8; 
      if(ctx.p.madness > 0) { ctx.p.madness--; dmg_val += 4; } 
      dmg(ctx, dmg_val); heal(ctx, dmg_val); 
    }},
    { id:'necromancy', name:'äº¡çµå¬å”¤', cost:3, cooldown:4, maxUses:0, desc:'å¬å”¤éª·é«…æˆ˜å£«ï¼Œè·å¾— 15 æ ¼æŒ¡å¹¶ä½¿æ•Œæ–¹ææƒ§ 2 å›åˆã€‚', type:'summon', character:'mortis', play:(ctx)=> { gainBlock(ctx, 15); addDebuff(ctx,'fear',2); } },
    { id:'memento', name:'æ­»äº¡é“­è®°', cost:1, cooldown:0, maxUses:2, desc:'è‹¥æ•Œæ–¹ç”Ÿå‘½â‰¤30%åˆ™å¤„å†³ï¼Œå¦åˆ™é€ æˆ 5 ä¼¤å®³ã€‚', type:'execute', character:'mortis', play:(ctx)=> { 
      if(game.enemy.hp <= game.enemy.maxHp * 0.3) kill(ctx); else dmg(ctx, 5); 
    }},
    
    // === Amoris é­…æƒ‘ç³»æŠ€èƒ½ ===
    { id:'charm', name:'é­…æƒ‘ä¹‹å»', cost:2, cooldown:2, maxUses:0, desc:'é€ æˆ 6 ä¼¤å®³ï¼Œæ•Œæ–¹é­…æƒ‘ 3 å›åˆï¼ˆæ”»å‡»-3ï¼‰ã€‚', type:'debuff', character:'amoris', play:(ctx)=> { dmg(ctx, 6); addDebuff(ctx,'charm',3); } },
    { id:'bloodRose', name:'è¡€è‰²ç«ç‘°', cost:1, cooldown:1, maxUses:0, desc:'é€ æˆ 4 ä¼¤å®³ï¼Œå›å¤ 6 ç”Ÿå‘½ã€‚æ–°æœˆæ—¶æ•ˆæœç¿»å€ã€‚', type:'attack', character:'amoris', play:(ctx)=> { 
      let dmg_val = 4, heal_val = 6; 
      if(game.moonPhase === 0) { dmg_val *= 2; heal_val *= 2; } 
      dmg(ctx, dmg_val); heal(ctx, heal_val); 
    }},
    { id:'seduction', name:'è¯±æƒ‘ä¹‹èˆ', cost:3, cooldown:3, maxUses:0, desc:'è·å¾— 12 æ ¼æŒ¡ï¼Œæ•Œæ–¹ä¸‹å›åˆè·³è¿‡è¡ŒåŠ¨ã€‚æ¶ˆè€— 2 ç‹‚æ°”å€¼ã€‚', type:'control', character:'amoris', play:(ctx)=> { 
      if(ctx.p.madness >= 2) { ctx.p.madness -= 2; gainBlock(ctx, 12); game.enemy.stunned = true; } 
      else { gainBlock(ctx, 8); } 
    }},
    { id:'vampiric', name:'å¸è¡€ä¹‹æ‹¥', cost:2, cooldown:2, maxUses:0, desc:'é€ æˆ 7 ä¼¤å®³ï¼Œå›å¤ç­‰é‡ç”Ÿå‘½ï¼Œè·å¾— 1 ç‹‚æ°”å€¼ã€‚', type:'attack', character:'amoris', play:(ctx)=> { dmg(ctx, 7); heal(ctx, 7); ctx.p.madness++; } },
    
    // === Timoris ææƒ§ç³»æŠ€èƒ½ ===
    { id:'terrorScream', name:'ææƒ§å°–å•¸', cost:2, cooldown:1, maxUses:0, desc:'é€ æˆ 8 ä¼¤å®³ï¼Œæ•Œæ–¹ææƒ§ 2 å›åˆã€‚ä¸‹å¼¦æœˆæ—¶+2ä¼¤å®³ã€‚', type:'attack', character:'timoris', play:(ctx)=> { 
      let dmg_val = 8; 
      if(game.moonPhase === 3) dmg_val += 2; 
      dmg(ctx, dmg_val); addDebuff(ctx,'fear',2); 
    }},
    { id:'nightmare', name:'å™©æ¢¦ç¼ ç»•', cost:1, cooldown:2, maxUses:0, desc:'æ•Œæ–¹æ˜“ä¼¤ 3 å›åˆï¼Œè‡ªèº«è·å¾— 1 ç‹‚æ°”å€¼ã€‚', type:'debuff', character:'timoris', play:(ctx)=> { addDebuff(ctx,'vuln',3); ctx.p.madness++; } },
    { id:'madness', name:'ç‹‚æ°”çˆ†å‘', cost:0, cooldown:4, maxUses:0, desc:'æ¶ˆè€—æ‰€æœ‰ç‹‚æ°”å€¼ï¼Œæ¯ç‚¹ç‹‚æ°”å€¼é€ æˆ 3 ä¼¤å®³ã€‚', type:'special', character:'timoris', play:(ctx)=> { 
      const madness = ctx.p.madness; 
      ctx.p.madness = 0; 
      dmg(ctx, madness * 3); 
    }},
    { id:'psychicStorm', name:'ç²¾ç¥é£æš´', cost:3, cooldown:3, maxUses:0, desc:'é€ æˆ 12 ä¼¤å®³ï¼Œæ•Œæ–¹æ··ä¹± 2 å›åˆï¼Œè‡ªèº«è·å¾— 2 ç‹‚æ°”å€¼ã€‚', type:'attack', character:'timoris', play:(ctx)=> { dmg(ctx, 12); addDebuff(ctx,'confusion',2); ctx.p.madness += 2; } },
    
    // === Oblivionis é—å¿˜ç³»æŠ€èƒ½ ===
    { id:'forget', name:'é—å¿˜ä¹‹é›¾', cost:2, cooldown:2, maxUses:0, desc:'æ•Œæ–¹é—å¿˜ 3 å›åˆï¼ˆæŠ€èƒ½å†·å´+1ï¼‰ï¼Œè·å¾— 8 æ ¼æŒ¡ã€‚', type:'debuff', character:'oblivionis', play:(ctx)=> { addDebuff(ctx,'forget',3); gainBlock(ctx, 8); } },
    { id:'voidTouch', name:'è™šæ— ä¹‹è§¦', cost:1, cooldown:1, maxUses:0, desc:'é€ æˆ 5 ä¼¤å®³ï¼Œæ•Œæ–¹å¤±å» 1 èƒ½é‡ã€‚ä¸Šå¼¦æœˆæ—¶+3ä¼¤å®³ã€‚', type:'attack', character:'oblivionis', play:(ctx)=> { 
      let dmg_val = 5; 
      if(game.moonPhase === 1) dmg_val += 3; 
      dmg(ctx, dmg_val); 
      if(game.enemy.energy) game.enemy.energy--; 
    }},
    { id:'memoryErase', name:'è®°å¿†æŠ¹é™¤', cost:3, cooldown:4, maxUses:0, desc:'é‡ç½®æ•Œæ–¹æ‰€æœ‰å¢ç›Šæ•ˆæœï¼Œé€ æˆ 10 ä¼¤å®³ã€‚', type:'dispel', character:'oblivionis', play:(ctx)=> { 
      game.enemy.buffs = {}; 
      dmg(ctx, 10); 
    }},
    
    // === ç»ˆææŠ€èƒ½ ===
    { id:'maskOfDespair', name:'ç»æœ›é¢å…·', cost:4, cooldown:5, maxUses:0, desc:'é€ æˆ 20 ä¼¤å®³ï¼Œæ•Œæ–¹ææƒ§ 3 å›åˆï¼Œè‡ªèº«è·å¾— 2 å •è½åº¦ã€‚', type:'ultimate', character:'all', play:(ctx)=> { 
      dmg(ctx, 20); 
      addDebuff(ctx,'fear',3); 
      increaseCorruption({p:ctx.p}); 
      increaseCorruption({p:ctx.p}); 
    }},
    { id:'moonlightSerenade', name:'æœˆå…‰å°å¤œæ›²', cost:3, cooldown:4, maxUses:0, desc:'å›å¤ 25 ç”Ÿå‘½ï¼Œè·å¾— 15 æ ¼æŒ¡ï¼Œæ”¹å˜æœˆç›¸ã€‚', type:'ultimate', character:'all', play:(ctx)=> { 
      heal(ctx, 25); 
      gainBlock(ctx, 15); 
      changeMoonPhase({p:ctx.p}); 
    }},
    { id:'aveMujicaFinale', name:'Ave Mujicaç»ˆç« ', cost:5, cooldown:6, maxUses:0, desc:'æ¶ˆè€—æ‰€æœ‰ç‹‚æ°”å’Œå •è½åº¦ï¼Œé€ æˆå·¨é¢ä¼¤å®³ã€‚', type:'ultimate', character:'all', play:(ctx)=> { 
      const totalPower = ctx.p.madness + ctx.p.corruption; 
      ctx.p.madness = 0; 
      ctx.p.corruption = 0; 
      dmg(ctx, totalPower * 5); 
    }},
    { id:'oblivion', name:'æ¹®ç­è™šç©º', cost:4, cooldown:5, maxUses:0, desc:'æ¶ˆè€— 3 ç‹‚æ°”å€¼ï¼Œè‹¥æ•Œæ–¹ç”Ÿå‘½â‰¤40%åˆ™ç›´æ¥å‡»æ€ï¼Œå¦åˆ™é€ æˆ 20 ä¼¤å®³ã€‚', type:'ultimate', character:'oblivionis', play:(ctx)=> { 
      if(ctx.p.madness >= 3) { 
        ctx.p.madness -= 3; 
        if(game.enemy.hp <= game.enemy.maxHp * 0.4) kill(ctx); 
        else dmg(ctx, 20); 
      } else dmg(ctx, 15); 
    }},
    
    // === é€šç”¨æŠ€èƒ½ ===
    { id:'masquerade', name:'å‡é¢èˆä¼š', cost:2, cooldown:3, maxUses:0, desc:'è·å¾— 10 æ ¼æŒ¡ï¼Œå›å¤ 8 ç”Ÿå‘½ï¼Œè·å¾— 1 ç‹‚æ°”å€¼ã€‚', type:'support', character:'all', play:(ctx)=> { gainBlock(ctx, 10); heal(ctx, 8); ctx.p.madness++; } },
    { id:'tarotCard', name:'å¡”ç½—å åœ', cost:1, cooldown:0, maxUses:3, desc:'éšæœºæ•ˆæœï¼šä¼¤å®³ã€æ²»ç–—ã€æ ¼æŒ¡æˆ–ç‹‚æ°”å€¼ã€‚', type:'random', character:'all', play:(ctx)=> tarotEffect(ctx) },
    { id:'lunarEclipse', name:'æœˆé£Ÿä»ªå¼', cost:3, cooldown:6, maxUses:0, desc:'å¼ºåˆ¶æ”¹å˜æœˆç›¸ä¸ºè¡€æœˆï¼Œæ‰€æœ‰æŠ€èƒ½å¢å¼º 1 å›åˆã€‚', type:'ritual', character:'all', play:(ctx)=> { 
      game.moonPhase = 'blood'; 
      ctx.p.enhancedTurns = 1; 
    }},
    { id:'corruption', name:'å •è½ä¹‹åŠ›', cost:1, cooldown:2, maxUses:0, desc:'å¢åŠ  1 å •è½åº¦ï¼Œæ ¹æ®å •è½åº¦è·å¾—ä¸åŒå¢ç›Šã€‚', type:'corruption', character:'all', play:(ctx)=> increaseCorruption(ctx) },
  ];
  
  function getBaseSkills(){ return ['shadowStrike', 'maskShift', 'bloodRose', 'forget', 'moonRitual']; }
  
  // ===== Ave Mujica ç³»ç»Ÿå‡½æ•° =====
  function changeMask(ctx) {
    const masks = Object.keys(MASKS);
    const currentIndex = masks.indexOf(ctx.p.currentMask);
    const nextIndex = (currentIndex + 1) % masks.length;
    ctx.p.currentMask = masks[nextIndex];
    addLog(`åˆ‡æ¢åˆ° ${MASKS[ctx.p.currentMask].name}`);
  }
  
  function changeMoonPhase(ctx) {
    const oldPhase = game.moonPhase;
    game.moonPhase = (game.moonPhase + 1) % 4;
    const phaseName = MOON_PHASES[game.moonPhase];
    addLog(`æœˆç›¸å˜åŒ–ï¼š${phaseName}`);
    
    // æ ¹æ®æœˆç›¸ç»™äºˆä¸åŒæ•ˆæœ
    switch(game.moonPhase) {
      case 0: // æ–°æœˆ
        heal(ctx, 8);
        ctx.p.madness++;
        break;
      case 1: // ä¸Šå¼¦
        gainBlock(ctx, 12);
        break;
      case 2: // æ»¡æœˆ
        ctx.p.energy++;
        break;
      case 3: // ä¸‹å¼¦
        dmg(ctx, 5);
        ctx.p.madness += 2;
        break;
    }
  }
  
  function tarotEffect(ctx) {
    const effects = [
      () => { dmg(ctx, 8); addLog('å¡”ç½—ï¼šæ„šè€… - é€ æˆ8ä¼¤å®³'); },
      () => { heal(ctx, 10); addLog('å¡”ç½—ï¼šå¥³ç¥­å¸ - å›å¤10ç”Ÿå‘½'); },
      () => { gainBlock(ctx, 12); addLog('å¡”ç½—ï¼šçš‡å¸ - è·å¾—12æ ¼æŒ¡'); },
      () => { ctx.p.madness++; addLog('å¡”ç½—ï¼šæ¶é­” - è·å¾—1ç‹‚æ°”å€¼'); },
      () => { ctx.p.energy++; addLog('å¡”ç½—ï¼šæ˜Ÿæ˜Ÿ - è·å¾—1èƒ½é‡'); },
      () => { addDebuff(ctx,'vuln',2); addLog('å¡”ç½—ï¼šæ­»ç¥ - æ•Œæ–¹æ˜“ä¼¤2å›åˆ'); }
    ];
    const effect = effects[Math.floor(Math.random() * effects.length)];
    effect();
  }
  
  function increaseCorruption(ctx) {
    if(ctx.p.corruption < 5) {
      ctx.p.corruption++;
      addLog(`å •è½åº¦å¢åŠ è‡³ ${ctx.p.corruption}`);
      
      // æ ¹æ®å •è½åº¦ç»™äºˆå¢ç›Š
      switch(ctx.p.corruption) {
        case 1:
          ctx.p.maxHp += 5;
          ctx.p.hp += 5;
          addLog('å •è½ä¹‹åŠ›ï¼šæœ€å¤§ç”Ÿå‘½+5');
          break;
        case 2:
          ctx.p.maxEnergy++;
          addLog('å •è½ä¹‹åŠ›ï¼šæœ€å¤§èƒ½é‡+1');
          break;
        case 3:
          ctx.p.madness += 2;
          addLog('å •è½ä¹‹åŠ›ï¼šç‹‚æ°”å€¼+2');
          break;
        case 4:
          addLog('å •è½ä¹‹åŠ›ï¼šæ‰€æœ‰æŠ€èƒ½å†·å´-1');
          break;
        case 5:
          addLog('å •è½ä¹‹åŠ›ï¼šè§£é”ç»ˆæå½¢æ€');
          break;
      }
    }
  }

  // ===== æ•Œäººä¸Boss =====
  function makeEnemy(floor){
    const base = { name:'Timoris', maxHp: 35+floor*5, hp:35+floor*5, block:0, intent:null, debuffs:{vuln:0, curse:0} };
    if(floor===7) return { ...base, name:'Oblivionis', maxHp: 100, hp:100 };
    return base;
  }

  // ===== é—ç‰© =====
  const RELICS = [
    { id:'rose', name:'ç»¯çº¢ç«ç‘°', desc:'+5 æœ€å¤§ç”Ÿå‘½', apply:p=> p.maxHp+=5 },
    { id:'feather', name:'é‡‘ç¾½', desc:'+1 æŠ½ç‰Œ', apply:p=> p.draw+=1 },
    { id:'chalice', name:'åœ£æ¯', desc:'æ¯å›åˆå¼€å§‹å›å¤2ç”Ÿå‘½', passive:'regen2' },
    { id:'maskHalf', name:'è£‚é¢å…·ç¢', desc:'é¦–å›åˆè·å¾— 6 æ ¼æŒ¡', passive:'firstBlock6' },
    { id:'sigil', name:'ç§˜çº¹', desc:'ä¼¤å®³+1', passive:'dmgPlus1' },
    { id:'bell', name:'ä»ªå¼ä¹‹é’Ÿ', desc:'æ¯å±‚å¼€å§‹+1 èƒ½é‡', passive:'floorEnergyPlus1' },
    { id:'moonCharm', name:'æœˆç¬¦', desc:'æ»¡æœˆæ—¶æ”»å‡»å†+2', passive:'fullMoonPlus2' },
    { id:'thorn', name:'è†æ£˜', desc:'å—å‡»åå¼¹2ä¼¤å®³', passive:'thorns2' },
    { id:'veil', name:'é»‘çº±', desc:'æˆ˜æ–—å¼€å§‹éšå¯‚ï¼šæ•Œæ–¹é¦–å›åˆæ”»å‡»-3', passive:'silence3' },
    { id:'ink', name:'å¢¨å¥‘', desc:'æŠ½åˆ°ç»ˆç„‰å’å¹æ—¶+1èƒ½é‡', passive:'ariaEnergy' },
    { id:'eye', name:'é‡‘ç³', desc:'æ˜“ä¼¤æŒç»­+1', passive:'vulnPlus1' },
    { id:'ember', name:'ä½™çƒ¬', desc:'æ¯æ¬¡å¤„å†³ï¼Œæ°¸ä¹…+1ä¼¤å®³', passive:'execStack' },
    
    // æ–°å¢é—ç‰©
    { id:'cursed_power', name:'è¯…å’’ä¹‹åŠ›', desc:'è¯…å’’æ¯å±‚+1ä¼¤å®³', passive:'cursedPower' },
    { id:'altar_blessing', name:'ç¥­å›ç¥ç¦', desc:'æŠ€èƒ½æ¶ˆè€—-1ï¼ˆæœ€ä½1ï¼‰', passive:'skillCostReduction' },
    { id:'mirror_shard', name:'é•œç‰‡ç¢ç‰‡', desc:'åå°„30%ä¼¤å®³', passive:'reflect30' },
    { id:'soul_blessing', name:'çµé­‚ç¥ç¦', desc:'æ¯å›åˆå¼€å§‹+1èƒ½é‡', passive:'soulEnergy' },
    { id:'statue_blessing', name:'é›•åƒç¥ç¦', desc:'å…ç–«é¦–æ¬¡è‡´å‘½ä¼¤å®³', passive:'deathWard' },
    { id:'stone_chunk', name:'çŸ³å—', desc:'+3æ ¼æŒ¡', passive:'stoneBlock' },
    { id:'healing_potion', name:'æ²»ç–—è¯æ°´', desc:'æˆ˜æ–—å¼€å§‹å›å¤10ç”Ÿå‘½', passive:'combatHeal' },
    { id:'warrior_soul', name:'æˆ˜å£«ä¹‹é­‚', desc:'æ”»å‡»æŠ€èƒ½+2ä¼¤å®³', passive:'warriorBonus' },
    { id:'ancient_weapon', name:'å¤è€æ­¦å™¨', desc:'æ‰€æœ‰ä¼¤å®³+3', passive:'ancientWeapon' },
    { id:'crystal_shard', name:'æ°´æ™¶ç¢ç‰‡', desc:'æŠ€èƒ½å†·å´-1å›åˆ', passive:'cooldownReduction' },
    { id:'forged_weapon', name:'é”»é€ æ­¦å™¨', desc:'æ”»å‡»+3ä¼¤å®³', passive:'forgedWeapon' },
    { id:'forged_armor', name:'é”»é€ æŠ¤ç”²', desc:'æ¯å›åˆ+2æ ¼æŒ¡', passive:'forgedArmor' },
    { id:'cursed_treasure', name:'è¯…å’’å®è—', desc:'æ‰€æœ‰æ•°å€¼+50%', passive:'cursedTreasure' },
    { id:'time_shard', name:'æ—¶é—´ç¢ç‰‡', desc:'æŠ€èƒ½ä½¿ç”¨æ¬¡æ•°+1', passive:'timeBonus' },
    { id:'scholar_wisdom', name:'å­¦è€…æ™ºæ…§', desc:'å­¦ä¹ æŠ€èƒ½æ—¶é¢å¤–è·å¾—1ä¸ª', passive:'scholarWisdom' },
    { id:'moon_blessing', name:'æœˆä¹‹ç¥ç¦', desc:'æ»¡æœˆæ—¶æ‰€æœ‰æ•ˆæœç¿»å€', passive:'moonBlessing' }
  ];

  // ===== æ¸²æŸ“ =====
  function renderHUD(){
    const hud = el('#hud'); hud.innerHTML='';
    const p = game.player, e = game.enemy || {hp:'â€”',block:'â€”'};
    const moonPhaseText = game.moonPhase === 'blood' ? 'è¡€æœˆ' : ['æ–°æœˆ','ä¸Šå¼¦','æ»¡æœˆ','ä¸‹å¼¦'][game.moonPhase];
    const maskName = (p.currentMask && MASKS[p.currentMask]) ? MASKS[p.currentMask].name : 'Dolorisé¢å…·';
    
    const stats = [
      `å±‚æ•° ${game.floor}/${game.maxFloor}`,
      `æœˆç›¸ ${moonPhaseText}`,
      `é¢å…· ${maskName}`,
      `èƒ½é‡ ${p.energy}/${p.maxEnergy}`,
      `ç”Ÿå‘½ ${p.hp}/${p.maxHp}`,
      `æ ¼æŒ¡ ${p.block}`,
      `ç‹‚æ°” ${p.madness || 0}/10`,
      `å •è½ ${p.corruption || 0}/5`,
      `æ•ŒäººHP ${e.hp}${e.block?(' +'+e.block):''}`,
    ];
    stats.forEach(s=> { const d=make('div',{className:'stat',innerText:s}); hud.appendChild(d); });
  }
  function renderSkills(){
    const skillsContainer = el('#hand'); skillsContainer.innerHTML='';
    game.player.skills.forEach(skillId=>{
      const skill = SKILL_DB.find(s=>s.id===skillId);
      if(!skill) return;
      
      const skillElement = make('div',{className:'skill'});
      const isOnCooldown = (game.player.skillCooldowns[skillId] || 0) > 0;
      const usesLeft = skill.maxUses > 0 ? skill.maxUses - (game.player.skillUses[skillId] || 0) : -1;
      const canUse = !isOnCooldown && (usesLeft !== 0) && game.player.energy >= skill.cost;
      
      if(!canUse) skillElement.classList.add('disabled');
      
      skillElement.appendChild(make('div',{className:'name',innerText:skill.name}));
      skillElement.appendChild(make('div',{className:'cost',innerText:`èƒ½é‡: ${skill.cost}`}));
      skillElement.appendChild(make('div',{className:'type',innerText:skill.type}));
      
      let statusText = '';
      if(isOnCooldown) statusText = `å†·å´: ${game.player.skillCooldowns[skillId]}å›åˆ`;
      else if(usesLeft >= 0) statusText = `å‰©ä½™: ${usesLeft}æ¬¡`;
      if(statusText) skillElement.appendChild(make('div',{className:'status',innerText:statusText}));
      
      skillElement.appendChild(make('div',{className:'desc',innerText:skill.desc}));
      
      if(canUse) {
        skillElement.onclick = ()=> useSkill(skillId);
      }
      skillsContainer.appendChild(skillElement);
    });
  }
  function renderRelics(){
    const wrap = el('#relics'); wrap.innerHTML='<h3 style="color:var(--gold);margin:4px 0;">é—ç‰©</h3>';
    if(game.player.relics.length===0){ wrap.append('ï¼ˆæ— ï¼‰'); return; }
    game.player.relics.forEach(r=>{ const rr = RELICS.find(x=>x.id===r); const d=make('div'); d.innerText = `â€¢ ${rr.name} â€” ${rr.desc}`; wrap.appendChild(d); });
  }

  // ===== ç«‹ç»˜æ›´æ–°å‡½æ•° =====
  function updateCharacterPortrait(){
    const portrait = el('#characterPortrait');
    // å§‹ç»ˆæ˜¾ç¤ºDolorisï¼Œå› ä¸ºå¥¹æ˜¯å”¯ä¸€çš„ä¸»è§’
    const characterName = 'Doloris';
    
    portrait.src = `pic/${characterName}.png`;
    portrait.alt = `${characterName} Portrait`;
  }

  function updateEnemyPortrait(){
    const portrait = el('#enemyPortrait');
    if(game.state === 'combat' && game.enemy) {
      portrait.src = `pic/${game.enemy.name}.png`;
      portrait.alt = `${game.enemy.name} Portrait`;
      portrait.classList.add('show');
    } else {
      portrait.classList.remove('show');
    }
  }
  function renderMap(){
    const map = el('#map'); 
    map.innerHTML = `
      <h3 style="color:var(--gold);margin:4px 0;">åœ°å›¾</h3>
      <div id="mapDisplay" style="
        background: var(--panel);
        border: 1px solid #222;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        min-height: 300px;
        position: relative;
      ">
        ${generateMapHTML()}
      </div>
    `;
    
    // åœ¨å·¦ä¾§å‰§åœºæ˜¾ç¤ºå¯¼èˆªé€‰é¡¹
    showMapNavigation();
  }
  
  function generateMapHTML() {
    const currentFloor = game.floor;
    const maxFloors = 7;
    let mapHTML = '';
    
    // æœˆç›¸å’Œè¿›åº¦æŒ‡ç¤ºå™¨
    mapHTML += `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="color: var(--gold); font-size: 12px;">
          <span style="color: var(--gold);">ğŸŒ™</span> ${getMoonPhaseName(game.moonPhase)}
        </div>
        <div style="color: var(--gold); font-size: 12px;">
          ç¬¬ ${currentFloor} / ${maxFloors} å±‚
        </div>
      </div>
      
      <div style="
        background: var(--panel);
        border: 1px solid #222;
        border-radius: 4px;
        height: 8px;
        margin-bottom: 20px;
        overflow: hidden;
      ">
        <div style="
          background: linear-gradient(90deg, var(--gold), var(--red));
          height: 100%;
          width: ${(currentFloor / maxFloors) * 100}%;
          transition: width 0.3s ease;
        "></div>
      </div>
    `;
    
    // ç”Ÿæˆåœ°å›¾å±‚çº§
    for(let floor = 1; floor <= maxFloors; floor++) {
      const isCurrentFloor = floor === currentFloor;
      const isCompleted = floor < currentFloor;
      const isAccessible = floor <= currentFloor;
      const isBossFloor = floor === maxFloors;
      
      // ä½¿ç”¨ç°æœ‰UIçš„æ ·å¼
      let bgColor, borderColor, roomColor;
      if(isCurrentFloor) {
        bgColor = 'var(--panel)';
        borderColor = 'var(--gold)';
        roomColor = 'var(--gold)';
      } else if(isCompleted) {
        bgColor = 'var(--panel)';
        borderColor = '#222';
        roomColor = 'var(--ok)';
      } else {
        bgColor = 'var(--panel)';
        borderColor = '#222';
        roomColor = '#666';
      }
      
      if(isBossFloor && isAccessible) {
        roomColor = 'var(--accent)';
      }
      
      mapHTML += `
        <div style="
          display: flex;
          align-items: center;
          margin: 6px 0;
          padding: 8px;
          border-radius: 6px;
          background: ${bgColor};
          border: 1px solid ${borderColor};
          transition: all 0.2s ease;
          ${isAccessible ? 'cursor: pointer;' : 'opacity: 0.5;'}
        " ${isAccessible ? `onclick="navigateToFloor(${floor})" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='${borderColor}'"` : ''}>
          
          <div style="
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: ${roomColor};
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
            color: ${isCurrentFloor || isCompleted ? 'var(--bg)' : 'var(--ink)'};
            border: 1px solid #222;
          ">
            ${isBossFloor ? 'ğŸ‘‘' : isCompleted ? 'âœ“' : isCurrentFloor ? 'â—' : floor}
          </div>
          
          <div style="flex: 1;">
            <div style="
              color: ${isCurrentFloor ? 'var(--gold)' : isCompleted ? 'var(--ok)' : 'var(--ink)'};
              font-weight: ${isCurrentFloor ? 'bold' : 'normal'};
              font-size: 13px;
            ">
              ${isBossFloor ? 'Bosså±‚ - æœ€ç»ˆæˆ˜æ–—' : `ç¬¬ ${floor} å±‚`}
            </div>
            <div style="
              color: #888;
              font-size: 11px;
              margin-top: 2px;
            ">
              ${getFloorDescription(floor, isCurrentFloor, isCompleted)}
            </div>
          </div>
          
          ${isCurrentFloor ? `
            <div style="
              color: var(--gold);
              font-size: 16px;
              animation: pulse 2s infinite;
            ">
              â¤
            </div>
          ` : ''}
        </div>
      `;
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€å±‚ï¼‰
      if(floor < maxFloors) {
        mapHTML += `
          <div style="
            width: 2px;
            height: 12px;
            background: ${floor < currentFloor ? 'var(--ok)' : '#222'};
            margin: 0 auto;
          "></div>
        `;
      }
    }
    
    return mapHTML;
  }
  
  function getFloorDescription(floor, isCurrent, isCompleted) {
    if(floor === 7) return 'æœ€ç»ˆBossæˆ˜æ–—';
    if(isCompleted) return 'å·²å®Œæˆ';
    if(isCurrent) return 'å½“å‰ä½ç½® - é€‰æ‹©è¡ŒåŠ¨';
    return 'æœªåˆ°è¾¾';
  }
  
  function showMapNavigation() {
    if(game.state !== 'map') return;
    
    setStory(`
      <div style="
        background: var(--panel);
        border: 1px solid #222;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
      ">
        <h3 style="color: var(--gold); text-align: center; margin-bottom: 15px;">
          ğŸ—ºï¸ ç¬¬ ${game.floor} å±‚æ¢ç´¢
        </h3>
        
        <p style="line-height: 1.6; color: var(--ink); margin-bottom: 15px; text-align: center;">
          ä½ ç«™åœ¨ç¬¬ ${game.floor} å±‚çš„å…¥å£ï¼Œé¢å‰æœ‰ä¸‰æ¡é“è·¯...
          æ¯ä¸€æ¡éƒ½é€šå‘ä¸åŒçš„å‘½è¿ã€‚
        </p>
        
        <div style="
          background: var(--bg);
          border: 1px solid #222;
          padding: 15px;
          border-radius: 6px;
          margin: 15px 0;
        ">
          <p style="color: var(--gold); font-style: italic; text-align: center;">
            "é€‰æ‹©ä½ çš„é“è·¯ï¼Œ${MASKS[game.player.currentMask].name}ã€‚
            æ¯ä¸€ä¸ªé€‰æ‹©éƒ½å°†å¡‘é€ ä½ çš„å‘½è¿..."
          </p>
        </div>
        
        <div style="
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 20px;
        ">
          <div style="color: var(--red); font-size: 12px;">âš”ï¸ æˆ˜æ–—</div>
          <div style="color: var(--gold); font-size: 12px;">ğŸ­ äº‹ä»¶</div>
          <div style="color: var(--ok); font-size: 12px;">ğŸ”¥ ä¼‘æ†©</div>
        </div>
      </div>
    `, [
      {
        text: 'âš”ï¸ å‰å¾€æˆ˜æ–—',
        on: () => {
          addLog('é€‰æ‹©äº†æˆ˜æ–—ä¹‹è·¯');
          enterNode(0);
        }
      },
      {
        text: 'ğŸ­ å‰å¾€äº‹ä»¶',
        on: () => {
          addLog('é€‰æ‹©äº†äº‹ä»¶ä¹‹è·¯');
          enterNode(1);
        }
      },
      {
        text: 'ğŸ”¥ å‰å¾€ä¼‘æ†©',
        on: () => {
          addLog('é€‰æ‹©äº†ä¼‘æ†©ä¹‹è·¯');
          enterNode(2);
        }
      }
    ]);
  }
  
  function navigateToFloor(targetFloor) {
    if(targetFloor > game.floor) {
      addLog('æ— æ³•å‰å¾€æœªæ¥çš„å±‚çº§');
      return;
    }
    
    if(targetFloor === game.floor) {
      addLog('ä½ å·²ç»åœ¨è¿™ä¸€å±‚äº†');
      showMapNavigation();
      return;
    }
    
    // å¯ä»¥æ·»åŠ å›é¡¾å·²å®Œæˆå±‚çº§çš„åŠŸèƒ½
    addLog(`å›é¡¾ç¬¬ ${targetFloor} å±‚çš„è®°å¿†...`);
  }
  function setStory(text, actions=[]) {
    const s = el('#story'); s.innerHTML = text;
    const act = el('#actions'); act.innerHTML='';
    actions.forEach(a=>{ const b=make('button',{innerText:a.text}); b.onclick=a.on; act.appendChild(b); });
  }
  
  function addLog(message) {
    // ç®€å•çš„æ—¥å¿—å‡½æ•°ï¼Œåœ¨å½“å‰æ•…äº‹æ–‡æœ¬åæ·»åŠ ä¿¡æ¯
    const s = el('#story');
    if(s.innerHTML) {
      s.innerHTML += '<br><small style="color: #888;">' + message + '</small>';
    }
  }

  // ===== æˆ˜æ–—ä¸æ•°å€¼ =====
  function dmg(ctx, base){ 
    const plus = hasPassive('dmgPlus1')?1:0; 
    const moonPlus = (game.moonPhase===2 && hasPassive('fullMoonPlus2'))?2:0; 
    let v = safeNum(base+plus+moonPlus);
    
    // ç‹‚æš´æ•ˆæœï¼šä¸‹æ¬¡æ”»å‡»ä¼¤å®³ç¿»å€
    if(ctx.p.nextAttackDouble) {
      v *= 2;
      ctx.p.nextAttackDouble = false;
    }
    
    const m = ctx.e.debuffs.vuln>0?1.5:1; const real = Math.floor(v*m);
    const blockHit = Math.min(real, ctx.e.block); ctx.e.block -= blockHit; ctx.e.block = clamp(ctx.e.block,0,999);
    const hpHit = real - blockHit; ctx.e.hp = clamp(ctx.e.hp - hpHit, 0, ctx.e.maxHp);
    bloodMoonFlash(); if(ctx.e.hp===0) onEnemyDefeated(); }
  function gainBlock(ctx, amt){ ctx.p.block = clamp(safeNum(ctx.p.block + amt), 0, 999); }
  function heal(ctx, amt){ ctx.p.hp = clamp(safeNum(ctx.p.hp + amt), 1, ctx.p.maxHp); }
  function kill(ctx){ ctx.e.hp = 0; onEnemyDefeated(true); }
  function addDebuff(ctx, key, amt){ ctx.e.debuffs[key] = clamp(safeNum(ctx.e.debuffs[key] + amt + (key==='vuln' && hasPassive('vulnPlus1')?1:0)),0,99); }
  function hasPassive(id){ return game.player.relics.some(r=> RELICS.find(x=>x.id===r)?.passive===id); }

  function startCombat(){
    game.state='combat'; game.enemy = makeEnemy(game.floor); game.player.block=0; game.player.energy=(game.player.maxEnergy || 3) + (hasPassive('floorEnergyPlus1')?1:0);
    if(hasPassive('firstBlock6')) game.player.block+=6;
    if(hasPassive('silence3')) game.enemy.intent = { type:'atk', val: Math.max(0, enemyIntentValue()-3) };
    else game.enemy.intent = { type:'atk', val: enemyIntentValue() };
    
    // é‡ç½®æŠ€èƒ½ä½¿ç”¨æ¬¡æ•°ï¼ˆæ¯åœºæˆ˜æ–—é‡ç½®ï¼‰
    game.player.skillUses = {};
    
    // æ˜¾ç¤ºæˆ˜æ–—å¼€å§‹å¯¹è¯
    showCombatStartDialogue();
    
    renderHUD(); renderSkills(); renderRelics(); renderCombatActions();
    updateEnemyPortrait();
    el('#mask').classList.remove('break');
  }
  
  function showCombatStartDialogue() {
    const mask = MASKS[game.player.currentMask];
    const enemyDialogue = getEnemyTaunt(game.enemy.name, game.floor);
    const playerDialogue = getPlayerCombatStart(game.player.currentMask, game.floor);
    
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: var(--gold);">ç¬¬ ${game.floor} å±‚æˆ˜æ–—</h3>
      </div>
      
      <div style="background: var(--panel); border: 1px solid #222; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <strong style="color: var(--red);">${game.enemy.name}ï¼š</strong><br>
        <em style="color: var(--red);">${enemyDialogue}</em>
      </div>
      
      <div style="background: var(--panel); border: 1px solid #222; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <strong style="color: ${mask.color};">${mask.name}ï¼š</strong><br>
        <em style="color: ${mask.color};">${playerDialogue}</em>
      </div>
      
      <p style="line-height: 1.6; text-align: center; color: var(--ink);">
        æˆ˜æ–—å¼€å§‹ï¼æœˆç›¸ï¼š${getMoonPhaseName(game.moonPhase)}
      </p>
    `, [{text:'å¼€å§‹æˆ˜æ–—', on:() => { 
      setStory(`<em>${game.player.name}</em> ç›´é¢ <em>${game.enemy.name}</em>ã€‚`, [{text:'ç»“æŸå›åˆ', on:endTurn}]);
    }}]);
  }
  
  function getEnemyTaunt(enemyName, floor) {
    const taunts = {
      'Timoris': [
        'åˆä¸€ä¸ªè¿·å¤±çš„çµé­‚...ä½ çš„ææƒ§å°†æˆä¸ºæˆ‘çš„å…»æ–™ã€‚',
        'åœ¨è¿™é‡Œï¼Œä½ çš„å™©æ¢¦å°†å˜æˆç°å®ã€‚',
        'é¢¤æŠ–å§ï¼Œå‡¡äººï¼ä½ çš„ææƒ§æš´éœ²äº†ä½ çš„å¼±ç‚¹ã€‚',
        'æˆ‘èƒ½é—»åˆ°ä½ å†…å¿ƒæ·±å¤„çš„ææƒ§...å¤šä¹ˆç¾å‘³ã€‚',
        'ä½ ä»¥ä¸ºæˆ´ä¸Šé¢å…·å°±èƒ½éšè—ææƒ§å—ï¼Ÿå¤ªå¤©çœŸäº†ã€‚'
      ],
      'Oblivionis': [
        'ä½ çš„å­˜åœ¨...å³å°†è¢«é—å¿˜ã€‚',
        'åœ¨è™šæ— é¢å‰ï¼Œä¸€åˆ‡éƒ½å°†å½’äºå¯‚é™ã€‚',
        'è®°å¿†ã€ç—›è‹¦ã€å¸Œæœ›...æˆ‘å°†æŠ¹é™¤ä¸€åˆ‡ã€‚',
        'ä½ å¾ˆå¿«å°±ä¼šå¿˜è®°è‡ªå·±ä¸ºä½•è€Œæ¥ã€‚',
        'æ¹®ç­æ˜¯æœ€ç»ˆçš„è§£è„±ï¼Œæ¥å—å®ƒå§ã€‚'
      ]
    };
    
    const enemyTaunts = taunts[enemyName] || [
      'ä½ ä¸åº”è¯¥æ¥åˆ°è¿™é‡Œ...',
      'è¿™é‡Œå°†æ˜¯ä½ çš„ç»ˆç‚¹ã€‚',
      'é¢å…·æ— æ³•æ‹¯æ•‘ä½ ã€‚',
      'ä½ çš„æ—…ç¨‹åˆ°æ­¤ä¸ºæ­¢ã€‚'
    ];
    
    // æ ¹æ®å±‚æ•°é€‰æ‹©æ›´æ¿€çƒˆçš„å°è¯
    if (floor >= 6) {
      return enemyTaunts[enemyTaunts.length - 1] || enemyTaunts[0];
    } else if (floor >= 3) {
      return enemyTaunts[Math.floor(enemyTaunts.length / 2)] || enemyTaunts[0];
    } else {
      return enemyTaunts[0];
    }
  }
  
  function getPlayerCombatStart(maskId, floor) {
    const dialogues = {
      'doloris': [
        'ç—›è‹¦æ˜¯æˆ‘çš„è€æœ‹å‹ï¼Œè€Œä½ ...åªæ˜¯å¦ä¸€ä¸ªæ•™è®­ã€‚',
        'åœ¨ç—›è‹¦ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†åŠ›é‡ã€‚ä½ å‡†å¤‡å¥½ä½“éªŒäº†å—ï¼Ÿ',
        'æ¯ä¸€æ¬¡ä¼¤ç—›éƒ½è®©æˆ‘æ›´å¼ºï¼Œä½ èƒ½ç»™æˆ‘å¸¦æ¥ä»€ä¹ˆï¼Ÿ',
        'ç—›è‹¦å¡‘é€ äº†æˆ‘ï¼Œç°åœ¨è½®åˆ°æˆ‘å¡‘é€ ä½ äº†ã€‚'
      ],
      'mortis': [
        'æ­»äº¡å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯å¯¹æ­»äº¡çš„æ— çŸ¥ã€‚',
        'ç”Ÿä¸æ­»åªæ˜¯å­˜åœ¨çš„ä¸¤ç§å½¢å¼ï¼Œè®©æˆ‘ä¸ºä½ æ¼”ç¤ºã€‚',
        'åœ¨æ­»äº¡çš„é˜´å½±ä¸‹ï¼ŒçœŸç›¸æ‰ä¼šæ˜¾ç°ã€‚',
        'ä½ å®³æ€•æ­»äº¡å—ï¼Ÿé‚£å°±è®©æˆ‘æ¥è§£æ”¾ä½ ã€‚'
      ],
      'amoris': [
        'çˆ±èƒ½æ²»æ„ˆä¸€åˆ‡ï¼Œä¹Ÿèƒ½æ¯ç­ä¸€åˆ‡ã€‚',
        'è®©æˆ‘ç”¨çˆ±æ¥æ‹¯æ•‘ä½ ...æˆ–è€…æ¯ç­ä½ ã€‚',
        'åœ¨çˆ±çš„åä¹‰ä¸‹ï¼Œæˆ‘å°†ç»™ä½ æœ€åçš„æ…ˆæ‚²ã€‚',
        'çˆ±æ˜¯æœ€ç¾çš„æ¯’è¯ï¼Œå“å°ä¸€ä¸‹å§ã€‚'
      ],
      'timoris': [
        'ææƒ§æ˜¯è¯šå®çš„æƒ…æ„Ÿï¼Œä¸è¦è¯•å›¾éšè—ã€‚',
        'åœ¨ææƒ§ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†çœŸæ­£çš„è‡ªå·±ã€‚',
        'ä½ çš„ææƒ§å°†æˆä¸ºæˆ‘çš„åŠ›é‡ã€‚',
        'æ‹¥æŠ±ææƒ§ï¼Œå®ƒä¼šè®©ä½ å˜å¾—æ›´å¼ºã€‚'
      ],
      'oblivionis': [
        'é—å¿˜æ˜¯è§£è„±ï¼Œè®©æˆ‘å¸®ä½ å¿˜è®°ç—›è‹¦ã€‚',
        'åœ¨è™šæ— ä¸­ï¼Œä¸€åˆ‡éƒ½å°†æ‰¾åˆ°å¹³é™ã€‚',
        'è®°å¿†æ˜¯è´Ÿæ‹…ï¼Œè®©æˆ‘ä¸ºä½ å‡è½»ã€‚',
        'é—å¿˜å¹¶éå¤±å»ï¼Œè€Œæ˜¯æ–°çš„å¼€å§‹ã€‚'
      ]
    };
    
    const maskDialogues = dialogues[maskId] || dialogues['doloris'];
    return maskDialogues[Math.min(floor - 1, maskDialogues.length - 1)];
  }
  
  function getMoonPhaseName(phase) {
    const names = ['æ–°æœˆ', 'ä¸Šå¼¦æœˆ', 'æ»¡æœˆ', 'ä¸‹å¼¦æœˆ'];
    return names[phase] || 'æ–°æœˆ';
  }
  
  function showSkillDialogue(skill, maskId) {
    const skillDialogues = {
      'shadowStrike': {
        'doloris': 'ç—›è‹¦å¦‚å½±éšå½¢ï¼',
        'mortis': 'æ­»äº¡çš„é˜´å½±é™ä¸´ï¼',
        'amoris': 'çˆ±çš„é˜´å½±æ‹¥æŠ±ä½ ï¼',
        'timoris': 'ææƒ§çš„é˜´å½±åå™¬ä¸€åˆ‡ï¼',
        'oblivionis': 'é—å¿˜çš„é˜´å½±æŠ¹é™¤å­˜åœ¨ï¼'
      },
      'maskShift': {
        'doloris': 'é¢å…·ä¹‹ä¸‹ï¼Œç—›è‹¦æ°¸æ’ï¼',
        'mortis': 'æ­»äº¡çš„é¢å…·ï¼Œç”Ÿå‘½çš„ç»ˆç»“ï¼',
        'amoris': 'çˆ±çš„é¢å…·ï¼Œæ¸©æŸ”çš„æ¯ç­ï¼',
        'timoris': 'ææƒ§çš„é¢å…·ï¼ŒçœŸå®çš„è‡ªæˆ‘ï¼',
        'oblivionis': 'è™šæ— çš„é¢å…·ï¼Œé—å¿˜çš„å¼€å§‹ï¼'
      },
      'bloodRose': {
        'doloris': 'è¡€è‰²ç«ç‘°ï¼Œç—›è‹¦ç»½æ”¾ï¼',
        'mortis': 'æ­»äº¡ä¹‹èŠ±ï¼Œå‡‹é›¶ä¹‹ç¾ï¼',
        'amoris': 'çˆ±çš„ç«ç‘°ï¼Œå¸¦åˆºçš„æ¸©æŸ”ï¼',
        'timoris': 'ææƒ§ä¹‹èŠ±ï¼Œé¢¤æ —çš„ç¾ä¸½ï¼',
        'oblivionis': 'é—å¿˜ä¹‹èŠ±ï¼Œè™šæ— çš„èŠ¬èŠ³ï¼'
      },
      'forget': {
        'doloris': 'å¿˜è®°ç—›è‹¦...ä¸ï¼Œæ‹¥æŠ±å®ƒï¼',
        'mortis': 'å¿˜è®°ç”Ÿå‘½ï¼Œæ‹¥æŠ±æ­»äº¡ï¼',
        'amoris': 'å¿˜è®°æ¨æ„ï¼Œåªç•™ä¸‹çˆ±ï¼',
        'timoris': 'å¿˜è®°å‹‡æ°”ï¼Œåªå‰©ææƒ§ï¼',
        'oblivionis': 'å¿˜è®°ä¸€åˆ‡ï¼Œå½’äºè™šæ— ï¼'
      },
      'moonRitual': {
        'doloris': 'æœˆå…‰è§è¯æˆ‘çš„ç—›è‹¦ï¼',
        'mortis': 'æœˆäº®å•Šï¼Œç…§äº®æ­»äº¡ä¹‹è·¯ï¼',
        'amoris': 'æœˆå…‰ä¸‹çš„çˆ±ï¼Œæ°¸æ’ä¸å˜ï¼',
        'timoris': 'æœˆå½±ä¸­çš„ææƒ§ï¼Œæ— å¤„å¯é€ƒï¼',
        'oblivionis': 'æœˆå…‰æ¶ˆæ•£ï¼Œä¸€åˆ‡å½’äºè™šæ— ï¼'
      }
    };
    
    const dialogue = skillDialogues[skill.id]?.[maskId] || `${skill.name}ï¼`;
    
    // ç®€çŸ­æ˜¾ç¤ºæŠ€èƒ½å°è¯
    const storyEl = el('#story');
    if (storyEl) {
      const originalContent = storyEl.innerHTML;
      storyEl.innerHTML = `<div style="color: ${MASKS[maskId].color}; font-style: italic; text-align: center; margin: 10px 0;">${dialogue}</div>` + originalContent;
      
      // 2ç§’åç§»é™¤å°è¯
      setTimeout(() => {
        if (storyEl.innerHTML.includes(dialogue)) {
          storyEl.innerHTML = originalContent;
        }
      }, 2000);
    }
  }
  
  function showVictoryDialogue(maskId, floor) {
    const victoryDialogues = {
      'doloris': [
        'ç—›è‹¦è®©æˆ‘æ›´å¼º...è¿™åªæ˜¯å¼€å§‹ã€‚',
        'æ¯ä¸€æ¬¡æˆ˜æ–—éƒ½æ˜¯ç—›è‹¦çš„æ´—ç¤¼ã€‚',
        'åœ¨ç—›è‹¦ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†èƒœåˆ©çš„çœŸè°›ã€‚',
        'ç—›è‹¦æ˜¯æˆ‘çš„è€å¸ˆï¼Œèƒœåˆ©æ˜¯æˆ‘çš„å¥–èµã€‚',
        'è¿™ä»½ç—›è‹¦...æˆ‘ä¼šçè—ã€‚',
        'è¶Šæ˜¯ç—›è‹¦ï¼Œè¶Šæ˜¯ç¾ä¸½ã€‚',
        'ç—›è‹¦çš„æè‡´ï¼Œå°±æ˜¯è¶…è¶Šã€‚'
      ],
      'mortis': [
        'æ­»äº¡ä¸æ˜¯ç»ˆç‚¹ï¼Œè€Œæ˜¯æ–°çš„å¼€å§‹ã€‚',
        'åœ¨æ­»äº¡çš„è¾¹ç¼˜ï¼Œæˆ‘çœ‹åˆ°äº†çœŸç›¸ã€‚',
        'ç”Ÿæ­»ä¹‹é—´ï¼Œæˆ‘é€‰æ‹©äº†åŠ›é‡ã€‚',
        'æ­»äº¡æ•™ä¼šäº†æˆ‘å¦‚ä½•ç”Ÿå­˜ã€‚',
        'è¿™åœºèƒœåˆ©ï¼ŒçŒ®ç»™æ­»å»çš„çµé­‚ã€‚',
        'æ­»äº¡çš„é˜´å½±ä¸‹ï¼Œæˆ‘ä¾ç„¶å‰è¡Œã€‚',
        'ç”Ÿä¸æ­»çš„ç•Œé™ï¼Œåœ¨æˆ‘é¢å‰æ¨¡ç³Šã€‚'
      ],
      'amoris': [
        'çˆ±èƒ½å¾æœä¸€åˆ‡ï¼ŒåŒ…æ‹¬æ•Œäººã€‚',
        'ç”¨çˆ±æˆ˜èƒœæ¨æ„ï¼Œè¿™å°±æ˜¯æˆ‘çš„é“è·¯ã€‚',
        'å³ä½¿åœ¨æˆ˜æ–—ä¸­ï¼Œçˆ±ä¾ç„¶å­˜åœ¨ã€‚',
        'èƒœåˆ©çš„æ»‹å‘³ï¼Œå› çˆ±è€Œç”œç¾ã€‚',
        'çˆ±è®©æˆ‘å˜å¾—æ›´å¼ºï¼Œä¹Ÿæ›´æ¸©æŸ”ã€‚',
        'åœ¨çˆ±çš„åä¹‰ä¸‹ï¼Œæˆ‘ä¸ä¼šåœæ­¢ã€‚',
        'çˆ±æ˜¯æœ€å¼ºçš„æ­¦å™¨ï¼Œä¹Ÿæ˜¯æœ€ç¾çš„ç›¾ç‰Œã€‚'
      ],
      'timoris': [
        'ææƒ§è®©æˆ‘ä¿æŒè­¦è§‰ã€‚',
        'åœ¨ææƒ§ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†å‹‡æ°”ã€‚',
        'ææƒ§æ˜¯è¯šå®çš„ï¼Œèƒœåˆ©ä¹Ÿæ˜¯ã€‚',
        'è¿™ä»½ææƒ§ï¼Œè®©èƒœåˆ©æ›´åŠ çè´µã€‚',
        'ææƒ§æ•™ä¼šäº†æˆ‘å¦‚ä½•æˆ˜æ–—ã€‚',
        'åœ¨ææƒ§çš„æ·±æ¸Šä¸­ï¼Œæˆ‘çœ‹åˆ°äº†å…‰æ˜ã€‚',
        'ææƒ§ä¸å‹‡æ°”ï¼Œåªæœ‰ä¸€çº¿ä¹‹éš”ã€‚'
      ],
      'oblivionis': [
        'èƒœåˆ©ä¹Ÿä¼šè¢«é—å¿˜ï¼Œä½†æ­¤åˆ»å®ƒå±äºæˆ‘ã€‚',
        'åœ¨è™šæ— ä¸­ï¼Œè¿™ä»½èƒœåˆ©æ˜¾å¾—æ ¼å¤–çè´µã€‚',
        'é—å¿˜ä¸€åˆ‡ï¼Œé™¤äº†è¿™ä¸€åˆ»çš„èƒœåˆ©ã€‚',
        'è™šæ— å¹¶ä¸æ„å‘³ç€å¤±è´¥ã€‚',
        'åœ¨é—å¿˜çš„è¾¹ç¼˜ï¼Œæˆ‘ä¾ç„¶å­˜åœ¨ã€‚',
        'è¿™åœºèƒœåˆ©ï¼Œå°†æˆä¸ºæ°¸æ’çš„è®°å¿†ã€‚',
        'å³ä½¿ä¸€åˆ‡éƒ½ä¼šè¢«é—å¿˜ï¼Œæˆ‘ä¾ç„¶æˆ˜æ–—ã€‚'
      ]
    };
    
    const dialogues = victoryDialogues[maskId] || victoryDialogues['doloris'];
    const dialogue = dialogues[Math.min(floor - 1, dialogues.length - 1)];
    
    // æ˜¾ç¤ºèƒœåˆ©æ„Ÿæ…¨
    const storyEl = el('#story');
    if (storyEl) {
      const victoryMessage = `<div style="background: var(--panel); border: 1px solid #222; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
        <strong style="color: ${MASKS[maskId].color};">${MASKS[maskId].name}ï¼š</strong><br>
        <em style="color: ${MASKS[maskId].color}; font-size: 1.1em;">${dialogue}</em>
      </div>`;
      
      storyEl.innerHTML = victoryMessage + storyEl.innerHTML;
    }
   }
   
   // ===== æ·±åº¦äº‹ä»¶å¯¹è¯ç³»ç»Ÿ =====
   
   function showMasqueradeBall() {
     const currentMask = MASKS[game.player.currentMask];
     setStory(`
       <div style="background: var(--panel); border: 1px solid #222; padding: 20px; border-radius: 8px; margin: 15px 0;">
         <h3 style="color: var(--gold); text-align: center; margin-bottom: 15px;">âœ¨ åä¸½çš„å‡é¢èˆä¼š âœ¨</h3>
         
         <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
           å¤è€çš„èˆå…ä¸­ï¼Œçƒ›å…‰æ‘‡æ›³ï¼ŒéŸ³ä¹å¦‚æ³£å¦‚è¯‰ã€‚äº”ä¸ªç¥ç§˜çš„é¢å…·é™é™åœ°æ‘†åœ¨ä¸ç»’å°åº§ä¸Šï¼Œ
           æ¯ä¸€ä¸ªéƒ½æ•£å‘ç€ä¸åŒçš„æ°”æ¯...
         </p>
         
         <div style="background: var(--bg); border: 1px solid #222; padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--gold); font-style: italic;">
             "æ¬¢è¿æ¥åˆ°æ°¸æ’çš„èˆä¼šï¼Œæ—…è€…ã€‚" ä¸€ä¸ªå£°éŸ³åœ¨ä½ è€³è¾¹è½»è¯­ï¼Œ
             "æ¯ä¸€ä¸ªé¢å…·éƒ½æ‰¿è½½ç€ä¸åŒçš„å‘½è¿...é€‰æ‹©å§ï¼Œè®©å®ƒæˆä¸ºä½ çµé­‚çš„ä¸€éƒ¨åˆ†ã€‚"
           </p>
         </div>
         
         <p style="color: var(--ink); text-align: center;">
           å½“å‰é¢å…·ï¼š<span style="color: ${currentMask.color};">${currentMask.name}</span>
         </p>
       </div>
     `, [
       {text: 'ğŸ­ ä¸èˆä¼šä¸»äººå¯¹è¯', on: () => showMasqueradeHost()},
       {text: 'ğŸ‘ï¸ ä»”ç»†è§‚å¯Ÿé¢å…·', on: () => showMaskExamination()},
       {text: 'ğŸ’ƒ å‚ä¸èˆè¹ˆ', on: () => showMasqueradeDance()},
       {text: 'ğŸšª ç¦»å¼€èˆä¼š', on: () => toNextFloor()}
     ]);
   }
   
   function showMasqueradeHost() {
     setStory(`
       <div style="background: var(--panel); border: 1px solid #222; padding: 20px; border-radius: 8px;">
         <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
           èˆä¼šä¸»äººç¼“ç¼“è½¬èº«ï¼Œä»–çš„é¢å®¹éšè—åœ¨åä¸½çš„é¢å…·ä¹‹åã€‚
           "ä½ çš„çœ¼ä¸­æœ‰ç€ç‰¹æ®Šçš„å…‰èŠ’...å‘Šè¯‰æˆ‘ï¼Œæ—…è€…ï¼Œä½ åœ¨å¯»æ‰¾ä»€ä¹ˆï¼Ÿ"
         </p>
         
         <div style="background: var(--bg); border: 1px solid #222; padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--gold); font-style: italic;">
             "åŠ›é‡ï¼Ÿæ•‘èµï¼Ÿè¿˜æ˜¯...é—å¿˜ï¼Ÿæ¯ä¸€ä¸ªé¢å…·éƒ½èƒ½ç»™ä½ ä¸åŒçš„ç­”æ¡ˆã€‚
             ä½†è®°ä½ï¼Œä¸€æ—¦é€‰æ‹©ï¼Œå°±æ— æ³•å›å¤´ã€‚"
           </p>
         </div>
       </div>
     `, [
       {text: 'ğŸ’ª "æˆ‘å¯»æ±‚åŠ›é‡"', on: () => showPowerPath()},
       {text: 'ğŸ’” "æˆ‘å¯»æ±‚æ•‘èµ"', on: () => showRedemptionPath()},
       {text: 'ğŸŒ™ "æˆ‘å¯»æ±‚çœŸç›¸"', on: () => showTruthPath()},
       {text: 'ğŸ”™ è¿”å›èˆä¼šå¤§å…', on: () => showMasqueradeBall()}
     ]);
   }
   
   function showPowerPath() {
     setStory(`
       <div style="background: var(--panel); border: 1px solid var(--red); padding: 20px; border-radius: 8px;">
         <p style="color: var(--ink); line-height: 1.8;">
           "åŠ›é‡...æ˜¯çš„ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„æ¸´æœ›ã€‚" ä¸»äººçš„å£°éŸ³å˜å¾—ä½æ²‰ï¼Œ
           "ä½†åŠ›é‡æ€»æ˜¯ä¼´éšç€ä»£ä»·ã€‚ä½ æ„¿æ„ä»˜å‡ºä»€ä¹ˆï¼Ÿ"
         </p>
         
         <div style="background: var(--bg); border: 1px solid var(--red); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--red); font-style: italic;">
             "Mortisçš„é¢å…·èƒ½ç»™ä½ æ­»äº¡çš„åŠ›é‡ï¼Œä½†ä½ çš„çµé­‚å°†æ‰¿å—æ°¸æ’çš„ç—›è‹¦...
             Timorisçš„é¢å…·èƒ½è®©ä½ æŒæ§ææƒ§ï¼Œä½†ä½ å°†æ°¸è¿œç”Ÿæ´»åœ¨é˜´å½±ä¸­..."
           </p>
         </div>
       </div>
     `, [
       {text: 'ğŸ’€ é€‰æ‹©Mortisé¢å…·ï¼ˆ+3ç‹‚æ°”ï¼Œ+å¼ºåŠ›æŠ€èƒ½ï¼‰', on: () => {
         game.player.currentMask = 'mortis';
         game.player.madness += 3;
         const ultimateSkills = SKILL_DB.filter(s => s.type === 'ultimate' && !game.player.skills.includes(s.id));
         if(ultimateSkills.length > 0) {
           game.player.skills.push(ultimateSkills[0].id);
         }
         addLog('è·å¾—äº†Mortisçš„æ­»äº¡ä¹‹åŠ›');
         renderHUD();
         showMaskTransformation('mortis');
       }},
       {text: 'ğŸ˜¨ é€‰æ‹©Timorisé¢å…·ï¼ˆ+2ç‹‚æ°”ï¼Œ+ææƒ§æŠ€èƒ½ï¼‰', on: () => {
         game.player.currentMask = 'timoris';
         game.player.madness += 2;
         game.player.skills.push('fearStrike');
         addLog('è·å¾—äº†Timorisçš„ææƒ§ä¹‹åŠ›');
         renderHUD();
         showMaskTransformation('timoris');
       }},
       {text: 'ğŸ”™ æˆ‘æ”¹å˜ä¸»æ„äº†', on: () => showMasqueradeHost()}
     ]);
   }
   
   function showRedemptionPath() {
     setStory(`
       <div style="background: var(--panel); border: 1px solid var(--gold); padding: 20px; border-radius: 8px;">
         <p style="color: var(--ink); line-height: 1.8;">
           "æ•‘èµ...å¤šä¹ˆç¾ä¸½è€Œç—›è‹¦çš„æ„¿æœ›ã€‚" ä¸»äººçš„å£°éŸ³å˜å¾—æ¸©æŸ”ï¼Œ
           "ä½†æ•‘èµéœ€è¦å‹‡æ°”é¢å¯¹è‡ªå·±çš„è¿‡å»ã€‚ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ"
         </p>
         
         <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--gold); font-style: italic;">
             "Amorisçš„é¢å…·èƒ½æ²»æ„ˆä½ çš„ä¼¤ç—›ï¼Œä½†ä½ å¿…é¡»å­¦ä¼šåŸè°…...
             Dolorisçš„é¢å…·èƒ½è®©ä½ æ¥å—ç—›è‹¦ï¼Œåœ¨ç—›è‹¦ä¸­æ‰¾åˆ°å¹³è¡¡..."
           </p>
         </div>
       </div>
     `, [
       {text: 'ğŸ’– é€‰æ‹©Amorisé¢å…·ï¼ˆ+15ç”Ÿå‘½ï¼Œ-1ç‹‚æ°”ï¼‰', on: () => {
         game.player.currentMask = 'amoris';
         game.player.maxHp += 15;
         game.player.hp += 15;
         if(game.player.madness > 0) game.player.madness--;
         addLog('è·å¾—äº†Amorisçš„çˆ±ä¹‹åŠ›');
         renderHUD();
         showMaskTransformation('amoris');
       }},
       {text: 'âš–ï¸ é€‰æ‹©Dolorisé¢å…·ï¼ˆå¹³è¡¡æ‰€æœ‰å±æ€§ï¼‰', on: () => {
         game.player.currentMask = 'doloris';
         heal({p:game.player}, 10);
         game.player.maxEnergy += 1;
         addLog('è·å¾—äº†Dolorisçš„å¹³è¡¡ä¹‹åŠ›');
         renderHUD();
         showMaskTransformation('doloris');
       }},
       {text: 'ğŸ”™ æˆ‘è¿˜æ²¡å‡†å¤‡å¥½', on: () => showMasqueradeHost()}
     ]);
   }
   
   function showTruthPath() {
     setStory(`
       <div style="background: var(--panel); border: 1px solid var(--accent); padding: 20px; border-radius: 8px;">
         <p style="color: var(--ink); line-height: 1.8;">
           "çœŸç›¸...æœ€å±é™©ä¹Ÿæœ€çè´µçš„è¿½æ±‚ã€‚" ä¸»äººçš„å£°éŸ³å˜å¾—ç¥ç§˜ï¼Œ
           "ä½†çœŸç›¸å¾€å¾€æ¯”è°è¨€æ›´åŠ æ®‹é…·ã€‚ä½ ç¡®å®šè¦çŸ¥é“å—ï¼Ÿ"
         </p>
         
         <div style="background: var(--bg); border: 1px solid var(--accent); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--accent); font-style: italic;">
             "Oblivionisçš„é¢å…·èƒ½è®©ä½ çœ‹åˆ°çœŸç›¸ï¼Œä½†ä½ å¯èƒ½ä¼šå¸Œæœ›å¿˜è®°æ‰€è§...
             æœ‰äº›çŸ¥è¯†ï¼Œä¸€æ—¦è·å¾—ï¼Œå°±æ— æ³•æŠ¹é™¤..."
           </p>
         </div>
       </div>
     `, [
       {text: 'ğŸŒ«ï¸ é€‰æ‹©Oblivionisé¢å…·ï¼ˆ+2æœ€å¤§èƒ½é‡ï¼Œ+ç‰¹æ®Šèƒ½åŠ›ï¼‰', on: () => {
         game.player.currentMask = 'oblivionis';
         game.player.maxEnergy += 2;
         game.player.skills.push('voidGaze');
         addLog('è·å¾—äº†Oblivionisçš„è™šæ— ä¹‹åŠ›');
         renderHUD();
         showMaskTransformation('oblivionis');
       }},
       {text: 'ğŸ“š è¯¢é—®é¢å…·çš„å†å²ï¼ˆ+1ç‹‚æ°”ï¼Œè·å¾—çŸ¥è¯†ï¼‰', on: () => {
         game.player.madness++;
         game.lorePages.push('é¢å…·çš„çœŸç›¸ï¼šå®ƒä»¬æ›¾ç»æ˜¯æ´»äººçš„è„¸...');
         addLog('è·å¾—äº†ç¦å¿ŒçŸ¥è¯†');
         renderHUD();
         toNextFloor();
       }},
       {text: 'ğŸ”™ æœ‰äº›çœŸç›¸ä¸å¿…çŸ¥é“', on: () => showMasqueradeHost()}
     ]);
   }
   
   function showMaskTransformation(maskId) {
     const mask = MASKS[maskId];
     setStory(`
       <div style="background: var(--panel); border: 1px solid ${mask.color}; padding: 20px; border-radius: 8px;">
         <h3 style="color: ${mask.color}; text-align: center;">é¢å…·èåˆ</h3>
         
         <p style="line-height: 1.8; color: var(--ink); text-align: center; margin: 20px 0;">
           é¢å…·ç¼“ç¼“è´´åˆä½ çš„è„¸åºï¼Œä¸€è‚¡å¥‡å¼‚çš„åŠ›é‡æ¶Œå…¥ä½ çš„èº«ä½“...
           ä½ æ„Ÿåˆ°è‡ªå·±æ­£åœ¨å‘ç”ŸæŸç§æ ¹æœ¬æ€§çš„æ”¹å˜ã€‚
         </p>
         
         <div style="background: var(--bg); border: 1px solid ${mask.color}; padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: ${mask.color}; font-style: italic; text-align: center;">
             "${getMaskTransformationText(maskId)}"
           </p>
         </div>
         
         <p style="color: var(--ink); text-align: center;">
           ä½ ç°åœ¨æ˜¯ <span style="color: ${mask.color};">${mask.name}</span>
         </p>
       </div>
     `, [{text: 'ç»§ç»­å‰è¡Œ', on: () => toNextFloor()}]);
   }
   
   function getMaskTransformationText(maskId) {
      const texts = {
        'doloris': 'ç—›è‹¦ä¸å¹³è¡¡åœ¨ä½ å¿ƒä¸­äº¤èï¼Œä½ å­¦ä¼šäº†åœ¨è‹¦éš¾ä¸­å¯»æ‰¾åŠ›é‡ã€‚',
        'mortis': 'æ­»äº¡çš„é˜´å½±ç¬¼ç½©ç€ä½ ï¼Œä½†ä½ ä¸å†ææƒ§ï¼Œå› ä¸ºä½ å·²ç»æˆä¸ºæ­»äº¡æœ¬èº«ã€‚',
        'amoris': 'çˆ±çš„æ¸©æš–å¡«æ»¡ä½ çš„å¿ƒæˆ¿ï¼Œå³ä½¿åœ¨æœ€é»‘æš—çš„æ—¶åˆ»ï¼Œä½ ä¹Ÿèƒ½æ‰¾åˆ°å…‰æ˜ã€‚',
        'timoris': 'ææƒ§æˆä¸ºä½ çš„ç›Ÿå‹ï¼Œåœ¨é˜´å½±ä¸­ï¼Œä½ æ‰¾åˆ°äº†çœŸæ­£çš„è‡ªå·±ã€‚',
        'oblivionis': 'è™šæ— çš„åŠ›é‡åœ¨ä½ ä½“å†…æµæ·Œï¼Œä½ å¼€å§‹ç†è§£é—å¿˜çš„çœŸæ­£æ„ä¹‰ã€‚'
      };
      return texts[maskId] || 'ä½ æ„Ÿå—åˆ°äº†é¢å…·çš„åŠ›é‡ã€‚';
    }
    
    function showMaskExamination() {
      setStory(`
        <div style="background: var(--panel); border: 1px solid var(--gold); padding: 20px; border-radius: 8px;">
          <h3 style="color: var(--gold); text-align: center;">é¢å…·çš„ç§˜å¯†</h3>
          
          <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
            ä½ ä»”ç»†è§‚å¯Ÿç€è¿™äº›é¢å…·ï¼Œæ¯ä¸€ä¸ªéƒ½æœ‰ç€ç‹¬ç‰¹çš„çº¹ç†å’Œæ°”æ¯...
          </p>
          
          <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
            <p style="color: var(--gold); font-style: italic;">
              åœ¨æœˆå…‰çš„ç…§è€€ä¸‹ï¼Œä½ å‘ç°è¿™äº›é¢å…·ä¼¼ä¹åœ¨è½»å¾®åœ°...å‘¼å¸ï¼Ÿ
              å®ƒä»¬çš„çœ¼å­”ä¸­é—ªçƒç€å¾®å¼±çš„å…‰èŠ’ï¼Œä»¿ä½›æœ‰ç”Ÿå‘½åœ¨å…¶ä¸­æµæ·Œã€‚
            </p>
          </div>
        </div>
      `, [
        {text: 'ğŸ” æ·±å…¥ç ”ç©¶é¢å…·ï¼ˆ+1ç‹‚æ°”ï¼Œè·å¾—çŸ¥è¯†ï¼‰', on: () => {
          game.player.madness++;
          game.lorePages.push('é¢å…·è§‚å¯Ÿè®°å½•ï¼šå®ƒä»¬ä¼¼ä¹ä¿ç•™ç€å‰ä¸»äººçš„è®°å¿†...');
          addLog('å‘ç°äº†é¢å…·çš„ç§˜å¯†');
          renderHUD();
          toNextFloor();
        }},
        {text: 'ğŸ‘† è§¦æ‘¸ä¸€ä¸ªé¢å…·', on: () => showMaskTouch()},
        {text: 'ğŸ”™ è¿”å›èˆä¼šå¤§å…', on: () => showMasqueradeBall()}
      ]);
    }
    
    function showMaskTouch() {
      const masks = ['doloris', 'mortis', 'amoris', 'timoris', 'oblivionis'];
      const randomMask = masks[rng.int(0, masks.length - 1)];
      const mask = MASKS[randomMask];
      
      setStory(`
        <div style="background: var(--panel); border: 1px solid ${mask.color}; padding: 20px; border-radius: 8px;">
          <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
            ä½ çš„æ‰‹æŒ‡è½»è§¦${mask.name}é¢å…·çš„è¡¨é¢ï¼Œç¬é—´ï¼Œä¸€è‚¡è®°å¿†çš„æ´ªæµæ¶Œå…¥ä½ çš„è„‘æµ·...
          </p>
          
          <div style="background: var(--bg); border: 1px solid ${mask.color}; padding: 15px; border-radius: 6px; margin: 15px 0;">
            <p style="color: ${mask.color}; font-style: italic;">
              "${getMaskMemory(randomMask)}"
            </p>
          </div>
          
          <p style="color: var(--ink); text-align: center;">
            è¿™äº›è®°å¿†ä¸å±äºä½ ï¼Œä½†ç°åœ¨å®ƒä»¬æˆä¸ºäº†ä½ çš„ä¸€éƒ¨åˆ†...
          </p>
        </div>
      `, [
        {text: 'ğŸ’­ æ¥å—è¿™äº›è®°å¿†ï¼ˆ+1ç‹‚æ°”ï¼Œ+ç‰¹æ®Šèƒ½åŠ›ï¼‰', on: () => {
          game.player.madness++;
          game.player.skills.push('memoryEcho');
          addLog(`è·å¾—äº†${mask.name}çš„è®°å¿†å›å“`);
          renderHUD();
          toNextFloor();
        }},
        {text: 'ğŸš« æŠ—æ‹’è®°å¿†ï¼ˆ-5ç”Ÿå‘½ï¼Œä¿æŒæ¸…é†’ï¼‰', on: () => {
          game.player.hp -= 5;
          addLog('æŠ—æ‹’äº†å¼‚è´¨è®°å¿†çš„ä¾µèš€');
          renderHUD();
          toNextFloor();
        }}
      ]);
    }
    
    function getMaskMemory(maskId) {
      const memories = {
        'doloris': 'ä¸€ä¸ªå¥³å­©åœ¨é›¨ä¸­å“­æ³£ï¼Œå¥¹çš„çœ¼æ³ªæ··åˆç€è¡€æ¶²...ç—›è‹¦è®©å¥¹å˜å¾—æ›´å¼ºï¼Œä½†ä¹Ÿæ›´åŠ å­¤ç‹¬ã€‚',
        'mortis': 'æ­»äº¡çš„é’Ÿå£°å“èµ·ï¼Œä¸€ä¸ªå¹´è½»äººåœ¨ç—…åºŠä¸Šå®‰é™åœ°é—­ä¸Šäº†çœ¼ç›...ä½†ä»–çš„çµé­‚æ‹’ç»ç¦»å»ã€‚',
        'amoris': 'ä¸¤ä¸ªæ‹äººåœ¨æœˆä¸‹èµ·èˆï¼Œä»–ä»¬çš„çˆ±å¦‚æ­¤çº¯çœŸ...ç›´åˆ°èƒŒå›çš„åŒ•é¦–åˆºå…¥å¿ƒè„ã€‚',
        'timoris': 'é»‘æš—ä¸­çš„å­©å­ç‘Ÿç‘Ÿå‘æŠ–ï¼Œææƒ§åå™¬ç€ä»–...ä½†åœ¨ææƒ§ä¸­ï¼Œä»–æ‰¾åˆ°äº†åŠ›é‡ã€‚',
        'oblivionis': 'ä¸€ä¸ªè€äººååœ¨ç©ºè¡çš„æˆ¿é—´é‡Œï¼Œä»–å¿˜è®°äº†ä¸€åˆ‡...åŒ…æ‹¬è‡ªå·±çš„åå­—ã€‚'
      };
      return memories[maskId] || 'æ¨¡ç³Šçš„è®°å¿†ç‰‡æ®µåœ¨ä½ è„‘æµ·ä¸­é—ªè¿‡...';
    }
    
    function showMasqueradeDance() {
      setStory(`
        <div style="background: var(--panel); border: 1px solid var(--accent); padding: 20px; border-radius: 8px;">
          <h3 style="color: var(--gold); text-align: center;">æ°¸æ’çš„èˆè¹ˆ</h3>
          
          <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
            ä½ èµ°å‘èˆæ± ä¸­å¤®ï¼ŒéŸ³ä¹å˜å¾—æ›´åŠ æ‚ æ‰¬ã€‚å…¶ä»–èˆè€…éƒ½æˆ´ç€é¢å…·ï¼Œ
            ä»–ä»¬çš„åŠ¨ä½œä¼˜é›…è€Œè¯¡å¼‚ï¼Œä»¿ä½›åœ¨è¿›è¡ŒæŸç§å¤è€çš„ä»ªå¼...
          </p>
          
          <div style="background: var(--bg); border: 1px solid var(--accent); padding: 15px; border-radius: 6px; margin: 15px 0;">
            <p style="color: var(--accent); font-style: italic;">
              éšç€èˆè¹ˆçš„è¿›è¡Œï¼Œä½ æ„Ÿåˆ°æ—¶é—´å˜å¾—æ¨¡ç³Šï¼Œç°å®ä¸å¹»è±¡äº¤ç»‡åœ¨ä¸€èµ·ã€‚
              è¿™ä¸ä»…ä»…æ˜¯èˆè¹ˆï¼Œæ›´åƒæ˜¯çµé­‚çš„äº¤æµ...
            </p>
          </div>
        </div>
      `, [
        {text: 'ğŸ’ƒ æ²‰æµ¸åœ¨èˆè¹ˆä¸­ï¼ˆ+1æœ€å¤§èƒ½é‡ï¼Œ+1ç‹‚æ°”ï¼‰', on: () => {
          game.player.maxEnergy++;
          game.player.madness++;
          addLog('åœ¨æ°¸æ’çš„èˆè¹ˆä¸­è·å¾—äº†åŠ›é‡');
          renderHUD();
          toNextFloor();
        }},
        {text: 'ğŸ­ å°è¯•ä¸å…¶ä»–èˆè€…äº¤æµ', on: () => showDancerInteraction()},
        {text: 'ğŸšª ç¦»å¼€èˆæ± ', on: () => showMasqueradeBall()}
      ]);
    }
    
    function showDancerInteraction() {
      const dancers = [
        {name: 'çº¢è¡£èˆè€…', color: '#FF6B6B', message: 'ä½ çš„ç—›è‹¦...æˆ‘èƒ½æ„Ÿå—åˆ°ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨ç—›è‹¦ä¸­èµ·èˆå§ã€‚'},
        {name: 'é»‘è¡£èˆè€…', color: '#2F2F2F', message: 'æ­»äº¡å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯å¯¹æ­»äº¡çš„æ— çŸ¥ã€‚'},
        {name: 'ç™½è¡£èˆè€…', color: '#FFB6C1', message: 'çˆ±æ˜¯æœ€ç¾çš„èˆè¹ˆï¼Œä¹Ÿæ˜¯æœ€ç—›çš„è¯—æ­Œã€‚'},
        {name: 'ç°è¡£èˆè€…', color: '#A0A0A0', message: 'åœ¨é—å¿˜ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ°¸æ’çš„å¹³é™ã€‚'}
      ];
      
      const dancer = dancers[rng.int(0, dancers.length - 1)];
      
      setStory(`
        <div style="background: var(--panel); border: 1px solid #222; padding: 20px; border-radius: 8px;">
          <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
            ä¸€ä½${dancer.name}å‘ä½ èµ°æ¥ï¼Œä»–ä»¬çš„åŠ¨ä½œå¦‚æ°´èˆ¬æµç•…ã€‚
            å½“ä½ ä»¬çš„ç›®å…‰ç›¸é‡æ—¶ï¼Œä»–ä»¬è½»å£°è¯´é“ï¼š
          </p>
          
          <div style="background: var(--bg); border: 1px solid #222; padding: 15px; border-radius: 6px; margin: 15px 0;">
            <p style="color: ${dancer.color}; font-style: italic;">
              "${dancer.message}"
            </p>
          </div>
        </div>
      `, [
        {text: 'ğŸ¤ ä¸èˆè€…å…±èˆï¼ˆè·å¾—ç‰¹æ®ŠæŠ€èƒ½ï¼‰', on: () => {
          const skills = ['dancingBlade', 'rhythmStrike', 'gracefulDodge'];
          const skill = skills[rng.int(0, skills.length - 1)];
          game.player.skills.push(skill);
          addLog(`ä»${dancer.name}é‚£é‡Œå­¦ä¼šäº†èˆè¹ˆæŠ€å·§`);
          renderHUD();
          toNextFloor();
        }},
        {text: 'ğŸ’¬ æ·±å…¥äº¤è°ˆï¼ˆ+1ç‹‚æ°”ï¼Œè·å¾—çŸ¥è¯†ï¼‰', on: () => {
          game.player.madness++;
          game.lorePages.push(`${dancer.name}çš„è¯è¯­ï¼šèˆè¹ˆæ˜¯çµé­‚çš„è¯­è¨€...`);
          addLog('è·å¾—äº†èˆè€…çš„æ™ºæ…§');
          renderHUD();
          toNextFloor();
        }},
        {text: 'ğŸ”™ ç¤¼è²Œåœ°ç¦»å¼€', on: () => showMasqueradeDance()}
      ]);
    }
    
    // ===== Ave Mujica æˆå‘˜é­é‡äº‹ä»¶ =====
    function showAveMujicaEncounter() {
      const members = [
        {
          name: 'Sakiko Togawa',
          title: 'å •è½çš„æŒ‡æŒ¥è€…',
          color: '#8B0000',
          dialogue: 'ä½ çš„çœ¼ä¸­æœ‰ç€ä¸æˆ‘ç›¸ä¼¼çš„é»‘æš—...å‘Šè¯‰æˆ‘ï¼Œä½ æ˜¯å¦ä¹Ÿåœ¨å¯»æ‰¾çœŸæ­£çš„è‡ªå·±ï¼Ÿ',
          choices: [
            {
              text: 'ğŸ’€ "æˆ‘åœ¨å¯»æ‰¾åŠ›é‡"',
              effect: () => {
                game.player.madness += 2;
                const darkSkills = SKILL_DB.filter(s => s.type === 'dark' && !game.player.skills.includes(s.id));
                if(darkSkills.length > 0) {
                  game.player.skills.push(darkSkills[0].id);
                }
                addLog('ä»Sakikoé‚£é‡Œå­¦åˆ°äº†é»‘æš—çš„åŠ›é‡');
              }
            },
            {
              text: 'ğŸ­ "æˆ‘åœ¨å¯»æ‰¾çœŸç›¸"',
              effect: () => {
                game.player.madness += 1;
                game.lorePages.push('Sakikoçš„è¯è¯­ï¼šçœŸç›¸å¾€å¾€æ¯”è°è¨€æ›´åŠ æ®‹é…·...');
                addLog('è·å¾—äº†Sakikoçš„æ™ºæ…§');
              }
            }
          ]
        },
        {
          name: 'Tomori Takamatsu',
          title: 'æ²‰é»˜çš„è§‚å¯Ÿè€…',
          color: '#4B0082',
          dialogue: 'éŸ³ä¹...æ˜¯çµé­‚çš„è¯­è¨€ã€‚ä½ çš„çµé­‚åœ¨å”±ä»€ä¹ˆæ­Œï¼Ÿ',
          choices: [
            {
              text: 'ğŸµ "æ‚²ä¼¤çš„æŒ½æ­Œ"',
              effect: () => {
                heal({p:game.player}, 10);
                game.player.madness++;
                addLog('Tomoriçš„éŸ³ä¹æ²»æ„ˆäº†ä½ çš„ä¼¤ç—›');
              }
            },
            {
              text: 'ğŸŒ™ "æœˆä¸‹çš„å’å¹è°ƒ"',
              effect: () => {
                changeMoonPhase({p:game.player});
                game.player.maxEnergy++;
                addLog('åœ¨Tomoriçš„æŒ‡å¯¼ä¸‹æ„Ÿå—åˆ°äº†æœˆä¹‹åŠ›é‡');
              }
            }
          ]
        },
        {
          name: 'Anon Chihaya',
          title: 'è¿·å¤±çš„å°‘å¥³',
          color: '#2F4F4F',
          dialogue: 'æˆ‘...æˆ‘ä¸è®°å¾—è‡ªå·±æ˜¯è°äº†ã€‚ä½†æ˜¯ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„ç—›è‹¦...',
          choices: [
            {
              text: 'ğŸ¤ "è®©æˆ‘å¸®åŠ©ä½ "',
              effect: () => {
                game.player.hp += 15;
                if(game.player.corruption > 0) game.player.corruption--;
                addLog('å¸®åŠ©Anonæ‰¾å›äº†ä¸€äº›è®°å¿†');
              }
            },
            {
              text: 'ğŸŒ«ï¸ "ä¸€èµ·é—å¿˜å§"',
              effect: () => {
                game.player.madness += 2;
                game.player.skills.push('memoryVoid');
                addLog('ä¸Anonä¸€èµ·æ²‰å…¥é—å¿˜çš„æ·±æ¸Š');
              }
            }
          ]
        },
        {
          name: 'Soyo Nagasaki',
          title: 'è™šå‡çš„å¾®ç¬‘',
          color: '#FFB6C1',
          dialogue: 'å¾®ç¬‘...æ˜¯æœ€å¥½çš„é¢å…·ã€‚ä½ æƒ³è¦æˆ‘æ•™ä½ å¦‚ä½•éšè—çœŸå®çš„è‡ªå·±å—ï¼Ÿ',
          choices: [
            {
              text: 'ğŸ˜Š "æ•™æˆ‘å¦‚ä½•å¾®ç¬‘"',
              effect: () => {
                game.player.skills.push('charmingSmile');
                game.player.corruption++;
                addLog('å­¦ä¼šäº†Soyoçš„è™šå‡å¾®ç¬‘');
              }
            },
            {
              text: 'ğŸ˜¢ "æˆ‘ä¸æƒ³éšè—"',
              effect: () => {
                game.player.madness--;
                game.player.hp += 10;
                addLog('é€‰æ‹©äº†çœŸå®çš„è‡ªå·±');
              }
            }
          ]
        },
        {
          name: 'Mutsumi Wakaba',
          title: 'çº¯çœŸçš„å®ˆæŠ¤è€…',
          color: '#98FB98',
          dialogue: 'å³ä½¿åœ¨æœ€é»‘æš—çš„åœ°æ–¹ï¼Œä¹Ÿè¦ä¿æŒå¿ƒä¸­çš„å…‰æ˜...ä½ è¿˜è®°å¾—å…‰æ˜æ˜¯ä»€ä¹ˆæ ·å­å—ï¼Ÿ',
          choices: [
            {
              text: 'âœ¨ "æˆ‘è¿˜è®°å¾—"',
              effect: () => {
                if(game.player.corruption > 0) game.player.corruption--;
                game.player.hp += 20;
                addLog('Mutsumiçš„çº¯çœŸå‡€åŒ–äº†ä½ çš„å¿ƒçµ');
              }
            },
            {
              text: 'ğŸŒ‘ "å…‰æ˜å·²ç»æ¶ˆå¤±äº†"',
              effect: () => {
                game.player.madness += 2;
                game.player.maxHp += 10;
                addLog('åœ¨é»‘æš—ä¸­æ‰¾åˆ°äº†å¦ä¸€ç§åŠ›é‡');
              }
            }
          ]
        }
      ];
      
      const member = members[rng.int(0, members.length - 1)];
      
      setStory(`
        <div style="background: var(--panel); border: 1px solid ${member.color}; padding: 20px; border-radius: 8px;">
          <h3 style="color: ${member.color}; text-align: center;">ç¥ç§˜çš„é­é‡</h3>
          
          <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
            åœ¨æ˜æš—çš„èµ°å»Šä¸­ï¼Œä½ é‡åˆ°äº†ä¸€ä¸ªç¥ç§˜çš„èº«å½±ã€‚å¥¹ç¼“ç¼“è½¬èº«ï¼Œéœ²å‡ºäº†ç†Ÿæ‚‰å´åˆé™Œç”Ÿçš„é¢å®¹...
          </p>
          
          <div style="background: var(--bg); border: 1px solid ${member.color}; padding: 15px; border-radius: 6px; margin: 15px 0;">
            <p style="color: ${member.color}; font-weight: bold; margin-bottom: 8px;">
              ${member.name} - ${member.title}
            </p>
            <p style="color: var(--ink); font-style: italic;">
              "${member.dialogue}"
            </p>
          </div>
          
          <p style="color: var(--ink); text-align: center; font-size: 0.9em;">
            å¥¹çš„çœ¼ä¸­é—ªçƒç€å¤æ‚çš„æƒ…æ„Ÿï¼Œç­‰å¾…ç€ä½ çš„å›ç­”...
          </p>
        </div>
      `, member.choices.map(choice => ({
        text: choice.text,
        on: () => {
          choice.effect();
          renderHUD();
          toNextFloor();
        }
      })).concat([
        {text: 'ğŸšª é»˜é»˜ç¦»å¼€', on: () => toNextFloor()}
      ]));
     }
     
     // ===== å¡”ç½—å åœäº‹ä»¶ =====
     function showTarotReading() {
       const cards = [
         {
           name: 'æ„šè€…',
           meaning: 'æ–°çš„å¼€å§‹',
           effect: () => {
             game.player.skills = [];
             game.player.hp = game.player.maxHp;
             addLog('æ„šè€…çš„åŠ›é‡è®©ä½ é‡æ–°å¼€å§‹');
           }
         },
         {
           name: 'æ­»ç¥',
           meaning: 'ç»ˆç»“ä¸é‡ç”Ÿ',
           effect: () => {
             game.player.hp = Math.max(1, game.player.hp - 20);
             game.player.maxHp += 15;
             game.player.madness += 2;
             addLog('æ­»ç¥å¸¦æ¥äº†ç—›è‹¦çš„èœ•å˜');
           }
         },
         {
           name: 'æœˆäº®',
           meaning: 'å¹»è±¡ä¸ç›´è§‰',
           effect: () => {
             changeMoonPhase({p:game.player});
             game.player.madness++;
             game.lorePages.push('æœˆäº®çš„ç§˜å¯†ï¼šç°å®ä¸æ¢¦å¢ƒçš„è¾¹ç•Œæ­£åœ¨æ¨¡ç³Š...');
             addLog('æœˆäº®æ­ç¤ºäº†éšè—çš„çœŸç›¸');
           }
         },
         {
           name: 'å¡”',
           meaning: 'çªç„¶çš„å˜åŒ–',
           effect: () => {
             const randomStat = ['hp', 'maxHp', 'energy', 'maxEnergy'][rng.int(0, 3)];
             if(randomStat.includes('max')) {
               game.player[randomStat] += rng.int(5, 15);
             } else {
               game.player[randomStat] = Math.max(1, game.player[randomStat] + rng.int(-10, 20));
             }
             addLog('å¡”çš„åŠ›é‡å¸¦æ¥äº†æ„å¤–çš„å˜åŒ–');
           }
         },
         {
           name: 'æ¶é­”',
           meaning: 'è¯±æƒ‘ä¸æŸç¼š',
           effect: () => {
             game.player.corruption += 2;
             game.player.madness++;
             const darkSkills = SKILL_DB.filter(s => s.type === 'dark' && !game.player.skills.includes(s.id));
             if(darkSkills.length > 0) {
               game.player.skills.push(darkSkills[0].id);
             }
             addLog('æ¶é­”çš„è¯±æƒ‘ç»™äºˆäº†é»‘æš—çš„åŠ›é‡');
           }
         }
       ];
       
       const card = cards[rng.int(0, cards.length - 1)];
       
       setStory(`
         <div style="background: var(--panel); border: 1px solid var(--gold); padding: 20px; border-radius: 8px;">
           <h3 style="color: var(--gold); text-align: center;">ç¥ç§˜çš„å¡”ç½—å åœ</h3>
           
           <p style="line-height: 1.8; color: var(--ink); margin-bottom: 15px;">
             åœ¨æ˜æš—çš„æˆ¿é—´é‡Œï¼Œä¸€ä½ç¥ç§˜çš„å åœå¸ˆååœ¨å¤è€çš„æ¡Œå­å‰ã€‚å¥¹çš„çœ¼ä¸­é—ªçƒç€æ™ºæ…§çš„å…‰èŠ’ï¼Œæ‰‹ä¸­çš„å¡”ç½—ç‰Œæ•£å‘ç€ç¥ç§˜çš„èƒ½é‡...
           </p>
           
           <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
             <p style="color: var(--gold); font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">
               ${card.name}
             </p>
             <p style="color: var(--ink); font-style: italic;">
               "${card.meaning}"
             </p>
           </div>
           
           <p style="color: var(--ink); text-align: center; font-size: 0.9em;">
             "è¿™å¼ ç‰Œæ­ç¤ºäº†ä½ å‘½è¿çš„ä¸€ä¸ªç‰‡æ®µ...ä½ å‡†å¤‡å¥½æ¥å—å®ƒçš„æŒ‡å¼•äº†å—ï¼Ÿ"
           </p>
         </div>
       `, [
         {
           text: 'ğŸ”® æ¥å—å‘½è¿çš„æŒ‡å¼•',
           on: () => {
             card.effect();
             renderHUD();
             toNextFloor();
           }
         },
         {
           text: 'ğŸšª æ‹’ç»å åœ',
           on: () => {
             addLog('ä½ é€‰æ‹©äº†ç›¸ä¿¡è‡ªå·±çš„é“è·¯');
             toNextFloor();
           }
         }
       ]);
     }
   
  function enemyIntentValue(){ return 5 + rng.int(0,3) + Math.floor(game.floor*0.5); }
  function renderCombatActions(){ const ca=el('#combatActions'); ca.innerHTML=''; const end=make('button',{innerText:'ç»“æŸå›åˆ'}); end.onclick=endTurn; ca.appendChild(end); }


  function rngShuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=rng.int(0,i); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function useSkill(skillId){ 
    const skill = SKILL_DB.find(s=>s.id===skillId); 
    if(!skill) return; 
    const p = game.player; 
    
    // æ£€æŸ¥èƒ½é‡ã€å†·å´å’Œä½¿ç”¨æ¬¡æ•°
    if(p.energy < skill.cost) return;
    if((p.skillCooldowns[skillId] || 0) > 0) return;
    if(skill.maxUses > 0 && (p.skillUses[skillId] || 0) >= skill.maxUses) return;
    
    // æ¶ˆè€—èƒ½é‡
    p.energy -= skill.cost; 
    
    // æ˜¾ç¤ºæŠ€èƒ½å°è¯
    showSkillDialogue(skill, p.currentMask);
    
    // æ‰§è¡ŒæŠ€èƒ½æ•ˆæœ
    const ctx = {p, e: game.enemy}; 
    skill.play(ctx);
    
    // è®¾ç½®å†·å´
    if(skill.cooldown > 0) {
      p.skillCooldowns[skillId] = skill.cooldown;
    }
    
    // å¢åŠ ä½¿ç”¨æ¬¡æ•°
    if(skill.maxUses > 0) {
      p.skillUses[skillId] = (p.skillUses[skillId] || 0) + 1;
    }
    
    el('#mask').classList.add('break');
    renderSkills(); renderHUD(); 
  }

  function endTurn(){ // æ•Œäººè¡ŒåŠ¨
    const e=game.enemy, p=game.player; const val = e.intent?.val ?? enemyIntentValue(); const dmgVal = Math.max(0, safeNum(val - p.block));
    const blockConsume = Math.min(p.block, val); p.block -= blockConsume; p.block = clamp(p.block,0,999);
    p.hp = clamp(p.hp - dmgVal, 0, p.maxHp);
    if(hasPassive('thorns2')) e.hp = clamp(e.hp - 2, 0, e.maxHp);
    if(e.hp===0){ onEnemyDefeated(); return; }
    
    // å›åˆåˆ·æ–°
    p.energy = (p.maxEnergy || 3) + (hasPassive('floorEnergyPlus1')?1:0);
    if(hasPassive('regen2')) heal({p},2);
    
    // æŠ€èƒ½å†·å´å‡å°‘
    for(let skillId in p.skillCooldowns) {
      if(p.skillCooldowns[skillId] > 0) {
        p.skillCooldowns[skillId]--;
        if(p.skillCooldowns[skillId] <= 0) {
          delete p.skillCooldowns[skillId];
        }
      }
    }
    
    // debuff/æ„å›¾åˆ·æ–°
    if(e.debuffs.vuln>0) e.debuffs.vuln--; if(e.debuffs.curse>0) { p.hp = clamp(p.hp-1,0,p.maxHp); }
    e.block = 0; e.intent = { type:'atk', val: enemyIntentValue() };
    renderHUD(); renderSkills(); setStory(`æ•Œæ–¹ä¸¾åˆƒï¼Œæ„å›¾é€ æˆ ${e.intent.val} ä¼¤å®³ã€‚`, [{text:'ç»“æŸå›åˆ', on:endTurn}]);
  }

  function onEnemyDefeated(executed=false){
    // æ˜¾ç¤ºèƒœåˆ©æ„Ÿæ…¨
    showVictoryDialogue(game.player.currentMask, game.floor);
    
    if(game.floor===7){ game.bossDefeated=true; playFinalChorus(); resolveEnding(); return; }
    // æ‰è½ï¼šæŠ€èƒ½æˆ–é—ç‰©æˆ–æ®‹é¡µ
    const rewardType = rng.int(0,2); if(rewardType===0){ offerSkills(); } else if(rewardType===1){ offerRelic(); } else { offerLore(); }
  }

  function offerSkills(){
    const availableSkills = SKILL_DB.filter(skill => !game.player.skills.includes(skill.id));
    const pool = rngShuffle(availableSkills).slice(0,3);
    setStory('é€‰æ‹©ä¸€ä¸ªæ–°æŠ€èƒ½å­¦ä¹ ï¼š', pool.map(skill=>({ text: skill.name, on(){ game.player.skills.push(skill.id); toNextFloor(); } })));
  }
  function offerRelic(){
    const pool = rngShuffle(RELICS).slice(0,2);
    setStory('é€‰æ‹©ä¸€ä»¶é—ç‰©ï¼š', pool.map(rr=>({ text: rr.name, on(){ game.player.relics.push(rr.id); rr.apply && rr.apply(game.player); renderRelics(); toNextFloor(); } })));
  }
  function offerLore(){ const text = ['æ®‹é¡µï¼šé¢å…·çš„è£‚çº¹æ‰¿è½½è®°å¿†ã€‚','æ®‹é¡µï¼šè¡€æœˆä¸æ˜¯å¤©è±¡ï¼Œè€Œæ˜¯èª“çº¦ã€‚','æ®‹é¡µï¼šç‹‚æ°”è‹¥è¢«å¼•å¯¼ï¼Œäº¦å¯æˆä¸ºé“è·¯ã€‚']; const pick = text[rng.int(0, text.length-1)];
    game.lorePages.push(pick); setStory(`${pick}`, [{text:'ç»§ç»­å‰è¡Œ', on:toNextFloor}]); }

  function toNextFloor(){ 
    game.floor++; 
    game.moonPhase = (game.moonPhase+1)%4; 
    game.state='map';
    
    // æ˜¾ç¤ºå±‚é—´è¿‡æ¸¡æ•…äº‹ï¼Œç„¶åè¿›å…¥åœ°å›¾
    showFloorTransition();
  }
  
  function showFloorTransition() {
    const characterNames = ['Doloris','Mortis','Amoris','Timoris','Oblivionis'];
    const currentCharacter = characterNames[(game.floor-1) % characterNames.length];
    const mask = MASKS[Object.keys(MASKS)[(game.floor-1) % Object.keys(MASKS).length]];
    
    // æ ¹æ®å±‚æ•°æ˜¾ç¤ºä¸åŒçš„è¿‡æ¸¡æ•…äº‹
    if (game.floor <= 7) {
      showRegularFloorTransition(currentCharacter, mask);
    } else {
      showFinalFloorTransition();
    }
  }
  
  function showRegularFloorTransition(characterName, mask) {
    const floorStories = {
      1: {
        title: 'ç—›è‹¦çš„å›å“',
        story: `
          <p style="line-height: 1.6;">
            ä½ è¸å…¥äº†ç¬¬ä¸€å±‚çš„æ·±å¤„ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æ·¡æ·¡çš„è¡€è…¥å‘³ã€‚
            å¢™å£ä¸Šåˆ»æ»¡äº†å¤è€çš„ç¬¦æ–‡ï¼Œæ¯ä¸€ä¸ªéƒ½åœ¨è¯‰è¯´ç€ç—›è‹¦çš„æ•…äº‹...
          </p>
          
          <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œ${characterName}çš„å£°éŸ³åœ¨èµ°å»Šä¸­å›å“ï¼šç—›è‹¦æ˜¯æˆé•¿çš„ä»£ä»·ï¼Œ
              åªæœ‰ç»å†è¿‡çœŸæ­£çš„ç—›è‹¦ï¼Œæ‰èƒ½ç†è§£åŠ›é‡çš„çœŸè°›...ã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: var(--ink);">
            ä½ æ„Ÿå—åˆ°é¢å…·åœ¨è½»å¾®é¢¤åŠ¨ï¼Œä»¿ä½›åœ¨å›åº”ç€è¿™äº›è¯è¯­ã€‚
            å‰æ–¹çš„é“è·¯å˜å¾—æ›´åŠ æ‰­æ›²ï¼Œç°å®ä¸å¹»è±¡å¼€å§‹äº¤ç»‡...
          </p>
        `,
        choices: [
           {text: 'å€¾å¬å†…å¿ƒçš„å£°éŸ³', action: () => { addMadnessDialogue(); }},
           {text: 'ç»§ç»­å‰è¿›', action: () => { renderMap(); }}
         ]
      },
      2: {
        title: 'æ­»äº¡çš„ä½è¯­',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬äºŒå±‚ç¬¼ç½©åœ¨æ­»å¯‚çš„æ°›å›´ä¸­ï¼Œä½ çš„è„šæ­¥å£°åœ¨ç©ºæ—·çš„èµ°å»Šé‡Œæ˜¾å¾—æ ¼å¤–æ¸…æ™°ã€‚
            å¢™å£ä¸Šçš„ç”»åƒä¼¼ä¹åœ¨æ³¨è§†ç€ä½ ï¼Œå®ƒä»¬çš„çœ¼ä¸­å……æ»¡äº†å¯¹æ­»äº¡çš„æ¸´æœ›...
          </p>
          
          <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œ${characterName}çš„å¹»å½±å‡ºç°åœ¨ä½ é¢å‰ï¼šæ­»äº¡å¹¶ä¸æ˜¯ç»ˆç»“ï¼Œ
              è€Œæ˜¯å¦ä¸€ç§å½¢å¼çš„å­˜åœ¨ã€‚åœ¨è¿™é‡Œï¼Œç”Ÿä¸æ­»çš„ç•Œé™å˜å¾—æ¨¡ç³Š...ã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: var(--ink);">
            ä½ æ„Ÿå—åˆ°ä¸€è‚¡å¯’æ„ä»è„ŠèƒŒå‡èµ·ï¼Œä½†åŒæ—¶ä¹Ÿæ„Ÿå—åˆ°äº†æŸç§è§£è„±ã€‚
            è¿™ç§çŸ›ç›¾çš„æ„Ÿè§‰è®©ä½ å¯¹è‡ªå·±çš„å­˜åœ¨äº§ç”Ÿäº†æ–°çš„æ€è€ƒ...
          </p>
        `,
        choices: [
          {text: 'ä¸æ­»äº¡å¯¹è¯', action: () => { addCorruptionDialogue(); }},
          {text: 'æ‹’ç»è¯±æƒ‘', action: () => { renderMap(); }}
        ]
      },
      3: {
        title: 'çˆ±æ‹çš„è¿·é›¾',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬ä¸‰å±‚è¢«ç²‰è‰²çš„è¿·é›¾ç¬¼ç½©ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€ç«ç‘°çš„é¦™æ°”ã€‚
            ä½†è¿™é¦™æ°”ä¸­éšè—ç€æŸç§å±é™©çš„ç”œè…»ï¼Œè®©äººæ—¢è¿·æ‹åˆææƒ§...
          </p>
          
          <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œ${characterName}çš„èº«å½±åœ¨è¿·é›¾ä¸­è‹¥éšè‹¥ç°ï¼šçˆ±æ˜¯æœ€ç¾çš„æ¯’è¯ï¼Œ
              å®ƒèƒ½æ²»æ„ˆä¸€åˆ‡ä¼¤ç—›ï¼Œä¹Ÿèƒ½å¸¦æ¥æœ€æ·±çš„ç»æœ›ã€‚ä½ å‡†å¤‡å¥½å“å°äº†å—ï¼Ÿã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: var(--ink);">
            ä½ çš„å¿ƒè·³å¼€å§‹åŠ é€Ÿï¼Œä¸çŸ¥é“æ˜¯å› ä¸ºææƒ§è¿˜æ˜¯æœŸå¾…ã€‚
            é¢å…·ä¼¼ä¹åœ¨å¼•å¯¼ä½ èµ°å‘æŸä¸ªç‰¹å®šçš„æ–¹å‘...
          </p>
        `,
        choices: [
          {text: 'æ‹¥æŠ±çˆ±çš„åŠ›é‡', action: () => { addLoveDialogue(); }},
          {text: 'ä¿æŒç†æ™º', action: () => { renderMap(); }}
        ]
      },
      4: {
        title: 'ææƒ§çš„æ·±æ¸Š',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬å››å±‚é™·å…¥äº†ç»å¯¹çš„é»‘æš—ï¼Œåªæœ‰ä½ é¢å…·çš„å¾®å…‰åœ¨æŒ‡å¼•æ–¹å‘ã€‚
            å››å‘¨ä¼ æ¥è‹¥æœ‰è‹¥æ— çš„çªƒçªƒç§è¯­ï¼Œé‚£äº›æ˜¯ä½ å†…å¿ƒæœ€æ·±å¤„çš„ææƒ§...
          </p>
          
          <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œ${characterName}çš„å£°éŸ³ä»é»‘æš—ä¸­ä¼ æ¥ï¼šææƒ§æ˜¯äººç±»æœ€åŸå§‹çš„æƒ…æ„Ÿï¼Œ
              ä¹Ÿæ˜¯æœ€è¯šå®çš„æƒ…æ„Ÿã€‚ä¸è¦é€ƒé¿å®ƒï¼Œæ‹¥æŠ±å®ƒï¼Œè®©å®ƒæˆä¸ºä½ çš„åŠ›é‡...ã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: #A0A0A0;">
            é»‘æš—ä¸­ä¼¼ä¹æœ‰ä»€ä¹ˆä¸œè¥¿åœ¨ç§»åŠ¨ï¼Œä½†å½“ä½ è¯•å›¾çœ‹æ¸…æ—¶ï¼Œ
            å®ƒä»¬åˆæ¶ˆå¤±äº†ã€‚è¿™ç§ä¸ç¡®å®šæ€§è®©ä½ çš„ææƒ§ä¸æ–­æ”¾å¤§...
          </p>
        `,
        choices: [
          {text: 'ç›´é¢å†…å¿ƒçš„ææƒ§', action: () => { addFearDialogue(); }},
          {text: 'å¯»æ‰¾å…‰æ˜', action: () => { renderMap(); }}
        ]
      },
      5: {
        title: 'é—å¿˜çš„è¾¹ç•Œ',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬äº”å±‚çš„ä¸€åˆ‡éƒ½æ˜¾å¾—æ¨¡ç³Šä¸æ¸…ï¼Œä»¿ä½›è¢«æŸç§åŠ›é‡æ•…æ„æŠ¹å»äº†ç»†èŠ‚ã€‚
            ä½ å¼€å§‹æ€€ç–‘è‡ªå·±çš„è®°å¿†ï¼Œç”šè‡³æ€€ç–‘è‡ªå·±çš„å­˜åœ¨...
          </p>
          
          <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œ${characterName}çš„èº«å½±å˜å¾—é€æ˜ï¼šé—å¿˜æ˜¯ä¸€ç§æ©èµï¼Œ
              å®ƒèƒ½è®©ä½ æ‘†è„±ç—›è‹¦çš„å›å¿†ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¸¦èµ°çè´µçš„ç»å†ã€‚
              ä½ æ„¿æ„ç”¨ä»€ä¹ˆæ¥æ¢å–è¿™ç§è§£è„±ï¼Ÿã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: #A0A0A0;">
            ä½ æ„Ÿè§‰è‡ªå·±çš„è®°å¿†åœ¨æ…¢æ…¢æµå¤±ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œ
            è¿™ç§æ„Ÿè§‰å¹¶ä¸å®Œå…¨ä»¤äººææƒ§ï¼Œåè€Œæœ‰ä¸€ç§å¥‡å¼‚çš„å¹³é™...
          </p>
        `,
        choices: [
          {text: 'æ‹¥æŠ±é—å¿˜', action: () => { addOblivionDialogue(); }},
          {text: 'åšæŒè®°å¿†', action: () => { renderMap(); }}
        ]
      },
      6: {
        title: 'çœŸç›¸çš„å‰å¤œ',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬å…­å±‚çš„ç©ºæ°”ä¸­å……æ»¡äº†ç´§å¼ æ„Ÿï¼Œä»¿ä½›æš´é£é›¨å‰çš„å®é™ã€‚
            ä½ æ„è¯†åˆ°è‡ªå·±æ­£åœ¨æ¥è¿‘æŸä¸ªé‡è¦çš„çœŸç›¸...
          </p>
          
          <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€Œæ‰€æœ‰é¢å…·çš„å£°éŸ³åŒæ—¶å“èµ·ï¼šçœŸç›¸å¾€å¾€æ¯”è°è¨€æ›´åŠ æ®‹é…·ï¼Œ
              ä½†åªæœ‰é¢å¯¹çœŸç›¸ï¼Œä½ æ‰èƒ½çœŸæ­£ç†è§£Ave Mujicaçš„æ„ä¹‰...ã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: #A0A0A0;">
            é¢å…·å¼€å§‹å‘å‡ºå¼ºçƒˆçš„å…‰èŠ’ï¼Œä½ æ„Ÿå—åˆ°å‰æ‰€æœªæœ‰çš„åŠ›é‡åœ¨ä½“å†…æ¶ŒåŠ¨ã€‚
            ä½†åŒæ—¶ï¼Œä½ ä¹Ÿæ„Ÿå—åˆ°äº†å·¨å¤§çš„è´£ä»»å’Œå‹åŠ›...
          </p>
        `,
        choices: [
          {text: 'å‡†å¤‡é¢å¯¹çœŸç›¸', action: () => { addTruthDialogue(); }},
          {text: 'ç»§ç»­å‰è¿›', action: () => { renderMap(); }}
        ]
      },
      7: {
        title: 'æœ€ç»ˆçš„è§‰æ‚Ÿ',
        story: `
          <p style="line-height: 1.6;">
            ç¬¬ä¸ƒå±‚ï¼Œæœ€åçš„è¯•ç‚¼ä¹‹åœ°ã€‚è¿™é‡Œçš„ä¸€åˆ‡éƒ½æ˜¾å¾—åº„ä¸¥è€Œç¥åœ£ï¼Œ
            ä»¿ä½›æ˜¯ä¸ºäº†æŸä¸ªé‡è¦çš„ä»ªå¼è€Œå‡†å¤‡çš„...
          </p>
          
          <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <em style="color: ${mask.color};">
              ã€ŒAve Mujicaçš„çœŸæ­£æ„ä¹‰å³å°†æ­æ™“ã€‚ä½ å·²ç»èµ°è¿‡äº†ç—›è‹¦ã€æ­»äº¡ã€çˆ±æ‹ã€ææƒ§å’Œé—å¿˜ï¼Œ
              ç°åœ¨æ˜¯æ—¶å€™å°†è¿™ä¸€åˆ‡èåˆï¼Œæ‰¾åˆ°å±äºä½ è‡ªå·±çš„ç­”æ¡ˆäº†...ã€
            </em>
          </div>
          
          <p style="line-height: 1.6; color: #A0A0A0;">
            å‰æ–¹çš„å…‰èŠ’è¶Šæ¥è¶Šå¼ºçƒˆï¼Œä½ çŸ¥é“æœ€ç»ˆçš„å¯¹å†³å³å°†åˆ°æ¥ã€‚
            æ— è®ºç»“æœå¦‚ä½•ï¼Œè¿™éƒ½å°†æ˜¯ä¸€æ¬¡æ”¹å˜å‘½è¿çš„ç›¸é‡...
          </p>
        `,
        choices: [
          {text: 'è¿æ¥æœ€ç»ˆè¯•ç‚¼', action: () => { renderMap(); }}
        ]
      }
    };
    
    const currentStory = floorStories[game.floor] || floorStories[7];
    
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: var(--gold);">ç¬¬ ${game.floor} å±‚ - ${currentStory.title}</h3>
      </div>
      ${currentStory.story}
    `, currentStory.choices.map(choice => ({
      text: choice.text,
      on: choice.action
    })));
    
    renderHUD(); 
    updateCharacterPortrait(); 
    updateEnemyPortrait();
  }
  
  function showFinalFloorTransition() {
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: #8B4B8C;">è¶…è¶Šç¬¬ä¸ƒå±‚ - æ— å°½çš„æ·±æ¸Š</h3>
      </div>
      
      <p style="line-height: 1.6;">
        ä½ å·²ç»è¶…è¶Šäº†åŸæœ¬çš„è¯•ç‚¼èŒƒå›´ï¼Œè¿›å…¥äº†æœªçŸ¥çš„é¢†åŸŸã€‚
        è¿™é‡Œçš„æ³•åˆ™å·²ç»ä¸å†é€‚ç”¨ï¼Œç°å®ä¸æ¢¦å¢ƒå®Œå…¨äº¤è...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œä½ å¬åˆ°äº†Ave Mujicaæ°¸æ’çš„æ—‹å¾‹ï¼Œé‚£æ˜¯è¶…è¶Šæ—¶é—´å’Œç©ºé—´çš„éŸ³ä¹ï¼Œ
          å¼•å¯¼ç€è¿·å¤±çš„çµé­‚æ‰¾åˆ°å½’å®¿...ã€
        </em>
      </div>
      
      <p style="line-height: 1.6; color: #A0A0A0;">
        åœ¨è¿™ä¸ªæ— å°½çš„æ·±æ¸Šä¸­ï¼Œä½ å°†é¢å¯¹æ›´åŠ å¼ºå¤§çš„æ•Œäººï¼Œ
        ä½†åŒæ—¶ä¹Ÿå°†è·å¾—æ›´åŠ æ·±åˆ»çš„é¢†æ‚Ÿ...
      </p>
    `, [
      {text: 'ç»§ç»­æ·±å…¥', on() { renderMap(); }}
    ]);
    
    renderHUD(); 
    updateCharacterPortrait(); 
    updateEnemyPortrait();
  }
  
  // å„ç§å¯¹è¯é€‰æ‹©çš„å‡½æ•°
  function addMadnessDialogue() {
    game.player.madness++;
    addLog('ä½ å€¾å¬äº†å†…å¿ƒçš„å£°éŸ³ï¼Œç‹‚æ°”å€¼+1');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©å€¾å¬å†…å¿ƒæ·±å¤„çš„å£°éŸ³ï¼Œé‚£äº›è¢«å‹æŠ‘çš„æƒ…æ„Ÿå¼€å§‹æ¶Œç°ã€‚
        ç—›è‹¦ã€æ„¤æ€’ã€ç»æœ›...ä½†åŒæ—¶ä¹Ÿæœ‰åŠ›é‡åœ¨å…¶ä¸­è¯ç”Ÿã€‚
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œä½ æ„Ÿå—åˆ°äº†çœŸæ­£çš„ç—›è‹¦ï¼Œä¹Ÿç†è§£äº†çœŸæ­£çš„åŠ›é‡ã€‚
          ç‹‚æ°”å¹¶éè¯…å’’ï¼Œè€Œæ˜¯é€šå‘çœŸç†çš„é“è·¯...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }
  
  function addCorruptionDialogue() {
    increaseCorruption({p: game.player});
    addLog('ä½ ä¸æ­»äº¡å¯¹è¯ï¼Œå •è½åº¦+1');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©ä¸æ­»äº¡å¯¹è¯ï¼Œæ„Ÿå—åˆ°äº†ç”Ÿå‘½çš„è„†å¼±å’Œæ­»äº¡çš„æ°¸æ’ã€‚
        è¿™ç§ä½“éªŒæ”¹å˜äº†ä½ å¯¹å­˜åœ¨çš„ç†è§£...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œæ­»äº¡æ•™ä¼šäº†ä½ ç”Ÿå‘½çš„çœŸè°›ã€‚åœ¨æ­»äº¡çš„é˜´å½±ä¸‹ï¼Œ
          ä½ å¼€å§‹ç†è§£ä»€ä¹ˆæ˜¯çœŸæ­£é‡è¦çš„...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }
  
  function addLoveDialogue() {
    heal({p: game.player}, 10);
    addLog('ä½ æ‹¥æŠ±äº†çˆ±çš„åŠ›é‡ï¼Œå›å¤10ç‚¹ç”Ÿå‘½');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©æ‹¥æŠ±çˆ±çš„åŠ›é‡ï¼Œæ„Ÿå—åˆ°äº†æ¸©æš–å’Œæ²»æ„ˆã€‚
        ä½†åŒæ—¶ï¼Œä½ ä¹Ÿæ„è¯†åˆ°çˆ±çš„åŒé¢æ€§...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œçˆ±æ²»æ„ˆäº†ä½ çš„ä¼¤ç—›ï¼Œä½†ä¹Ÿåœ¨ä½ å¿ƒä¸­ç§ä¸‹äº†æ–°çš„ç§å­ã€‚
          è¿™ç§å­å°†ä¼šå¼€å‡ºä»€ä¹ˆæ ·çš„èŠ±æœµï¼Œåªæœ‰æ—¶é—´èƒ½å¤Ÿå‘Šè¯‰ä½ ...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }
  
  function addFearDialogue() {
    game.player.madness++;
    game.player.maxEnergy++;
    addLog('ä½ ç›´é¢äº†ææƒ§ï¼Œç‹‚æ°”å€¼+1ï¼Œæœ€å¤§èƒ½é‡+1');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©ç›´é¢å†…å¿ƒçš„ææƒ§ï¼Œåœ¨é»‘æš—ä¸­æ‰¾åˆ°äº†æ–°çš„åŠ›é‡ã€‚
        ææƒ§ä¸å†æ˜¯æŸç¼šï¼Œè€Œæ˜¯æˆé•¿çš„å‚¬åŒ–å‰‚...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œææƒ§æ•™ä¼šäº†ä½ å‹‡æ°”çš„çœŸè°›ã€‚åªæœ‰ç»å†è¿‡çœŸæ­£çš„ææƒ§ï¼Œ
          æ‰èƒ½ç†è§£ä»€ä¹ˆæ˜¯çœŸæ­£çš„å‹‡æ•¢...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }
  
  function addOblivionDialogue() {
    if (game.player.madness > 0) game.player.madness--;
    if (game.player.corruption > 0) game.player.corruption--;
    addLog('ä½ æ‹¥æŠ±äº†é—å¿˜ï¼Œç‹‚æ°”å€¼-1ï¼Œå •è½åº¦-1');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©æ‹¥æŠ±é—å¿˜ï¼Œæ„Ÿå—åˆ°äº†å‰æ‰€æœªæœ‰çš„å¹³é™ã€‚
        ç—›è‹¦çš„è®°å¿†å¼€å§‹æ¨¡ç³Šï¼Œä½†åŒæ—¶çè´µçš„å›å¿†ä¹Ÿåœ¨æ¶ˆå¤±...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€Œé—å¿˜å¸¦æ¥äº†è§£è„±ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ç©ºè™šã€‚
          åœ¨å¤±å»ä¸è·å¾—ä¹‹é—´ï¼Œä½ æ‰¾åˆ°äº†æ–°çš„å¹³è¡¡...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }
  
  function addTruthDialogue() {
    game.player.maxHp += 10;
    game.player.hp += 10;
    addLog('ä½ å‡†å¤‡é¢å¯¹çœŸç›¸ï¼Œæœ€å¤§ç”Ÿå‘½+10');
    setStory(`
      <p style="line-height: 1.6;">
        ä½ é€‰æ‹©å‡†å¤‡é¢å¯¹çœŸç›¸ï¼Œæ„Ÿå—åˆ°äº†å†…å¿ƒçš„åšå®šã€‚
        æ— è®ºçœŸç›¸å¤šä¹ˆæ®‹é…·ï¼Œä½ éƒ½å·²ç»åšå¥½äº†å‡†å¤‡...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: #8B4B8C;">
          ã€ŒçœŸç›¸çš„åŠ›é‡è®©ä½ å˜å¾—æ›´åŠ å¼ºå¤§ã€‚
          åªæœ‰æ•¢äºé¢å¯¹çœŸç›¸çš„äººï¼Œæ‰èƒ½è·å¾—çœŸæ­£çš„è‡ªç”±...ã€
        </em>
      </div>
    `, [
      {text: 'ç»§ç»­å‰è¿›', on() { renderMap(); }}
    ]);
    renderHUD();
  }

  // ===== åœ°å›¾/äº‹ä»¶/ä¼‘æ†© =====
  function enterNode(i){ if(i===0) startCombat(); else if(i===1) randomEvent(); else campfire(); }
  function randomEvent(){ 
    const events = [
      // ===== Ave Mujica ä¸»é¢˜äº‹ä»¶ =====
      
      // å‡é¢èˆä¼šäº‹ä»¶ - æ·±åº¦å¯¹è¯ç‰ˆæœ¬
      () => showMasqueradeBall(),
      
      // å¡”ç½—å åœäº‹ä»¶ - æ·±åº¦å¯¹è¯ç‰ˆæœ¬
      () => showTarotReading(),
      
      // æœ¨å¶å‰§åœºäº‹ä»¶
      () => setStory('å¤è€çš„æœ¨å¶å‰§åœºï¼Œèˆå°ä¸Šæ­£åœ¨ä¸Šæ¼”æ‚²å‰§...', [
        {text:'è§‚çœ‹ã€Šå •è½å¤©ä½¿ã€‹ï¼ˆ+1å •è½åº¦ï¼‰', on(){ 
          increaseCorruption({p:game.player}); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'è§‚çœ‹ã€Šæœˆä¸‹é‡ç”Ÿã€‹ï¼ˆ+15ç”Ÿå‘½ï¼Œæ”¹å˜æœˆç›¸ï¼‰', on(){ 
          heal({p:game.player}, 15); 
          changeMoonPhase({p:game.player}); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'æˆä¸ºæœ¨å¶å¸ˆï¼ˆè·å¾—æ“æ§ç±»æŠ€èƒ½ï¼‰', on(){ 
          const controlSkills = SKILL_DB.filter(s => s.type === 'control' && !game.player.skills.includes(s.id));
          if(controlSkills.length > 0) {
            game.player.skills.push(controlSkills[0].id);
          }
          toNextFloor(); 
        }},
        {text:'ç¦»å¼€å‰§åœºï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // ç¥ç§˜çš„Ave Mujicaæˆå‘˜äº‹ä»¶ - æ·±åº¦å¯¹è¯ç‰ˆæœ¬
      () => showAveMujicaEncounter(),
      
      // è¡€æœˆç¥­å…¸äº‹ä»¶
      () => setStory('è¡€æœˆå‡èµ·ï¼Œå¤è€çš„ç¥­å…¸å¼€å§‹äº†...', [
        {text:'å‚ä¸è¡€æœˆä»ªå¼ï¼ˆ+2å •è½åº¦ï¼Œè·å¾—ç»ˆææŠ€èƒ½ï¼Œæœˆç›¸å˜è¡€æœˆï¼‰', on(){ 
          increaseCorruption({p:game.player}); 
          increaseCorruption({p:game.player}); 
          const ultimateSkills = SKILL_DB.filter(s => s.type === 'ultimate' && !game.player.skills.includes(s.id));
          if(ultimateSkills.length > 0) {
            game.player.skills.push(ultimateSkills[0].id);
          }
          game.moonPhase = 'blood';
          renderHUD(); toNextFloor(); 
        }},
        {text:'æŠµæŠ—è¡€æœˆè¯±æƒ‘ï¼ˆ-10ç”Ÿå‘½ï¼Œ-1å •è½åº¦ï¼‰', on(){ 
          game.player.hp -= 10; 
          if(game.player.corruption > 0) game.player.corruption--;
          addLog('æŠµæŠ—äº†è¡€æœˆçš„è¯±æƒ‘'); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'é€ƒç¦»ç¥­å…¸ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // éª‘å£«å¢“åœ°äº‹ä»¶
      () => setStory('å¤è€çš„éª‘å£«å¢“åœ°ï¼Œå¢“ç¢‘ä¸Šåˆ»ç€é€è€…çš„åå­—...', [
        {text:'ç¼…æ€€æ­»äº¡éª‘å£«ï¼ˆ+1ç‹‚æ°”ï¼Œè·å¾—æ­»äº¡éª‘å£«ç¥ç¦é—ç‰©ï¼‰', on(){ 
          game.player.relics.push('death_knight_blessing'); 
          game.player.madness++; 
          addLog('è·å¾—æ­»äº¡éª‘å£«çš„ç¥ç¦'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'æŒ–æ˜å¤å¢“ï¼ˆ+1å •è½åº¦ï¼Œè·å¾—å¤è€é—ç‰©ï¼‰', on(){ 
          increaseCorruption({p:game.player}); 
          game.player.relics.push('ancient_relic'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'çŒ®èŠ±è‡´æ•¬ï¼ˆ+20ç”Ÿå‘½ï¼‰', on(){ 
          heal({p:game.player}, 20); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€å¢“åœ°ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // ç¥ç§˜å•†åº—äº‹ä»¶
      () => setStory('ä¸€ä¸ªæˆ´ç€é¢å…·çš„å•†äººå‡ºç°ï¼šã€Œç”¨ç‹‚æ°”æ¢å–ç¦å¿ŒçŸ¥è¯†å¦‚ä½•ï¼Ÿã€', [
        {text:'ç”¨ç‹‚æ°”è´­ä¹°æŠ€èƒ½ï¼ˆ-3ç‹‚æ°”ï¼Œé€‰æ‹©æ–°æŠ€èƒ½ï¼‰', on(){ 
          if(game.player.madness >= 3) { 
            game.player.madness -= 3; 
            offerSkills(); 
          } else { 
            addLog('ç‹‚æ°”ä¸è¶³'); 
            toNextFloor(); 
          }
        }},
        {text:'ç”¨ç”Ÿå‘½è´­ä¹°é—ç‰©ï¼ˆ-15ç”Ÿå‘½ï¼Œé€‰æ‹©æ–°é—ç‰©ï¼‰', on(){ 
          if(game.player.hp > 15) { 
            game.player.hp -= 15; 
            offerRelic(); 
          } else { 
            addLog('ç”Ÿå‘½ä¸è¶³'); 
            toNextFloor(); 
          }
        }},
        {text:'ç”¨å •è½åº¦è´­ä¹°ç¦å¿ŒæŠ€èƒ½ï¼ˆ-2å •è½åº¦ï¼Œè·å¾—ç¦å¿ŒæŠ€èƒ½ï¼‰', on(){ 
          if(game.player.corruption >= 2) { 
            game.player.corruption -= 2; 
            const forbiddenSkills = SKILL_DB.filter(s => s.type === 'forbidden' && !game.player.skills.includes(s.id));
            if(forbiddenSkills.length > 0) {
              game.player.skills.push(forbiddenSkills[0].id);
            }
            renderHUD(); toNextFloor(); 
          } else { 
            addLog('å •è½åº¦ä¸è¶³'); 
            toNextFloor(); 
          }
        }},
        {text:'ç¦»å¼€ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // æœˆä¹‹ç¥æ®¿äº‹ä»¶
      () => setStory('æœˆä¹‹ç¥æ®¿çŸ—ç«‹åœ¨ä½ é¢å‰ï¼Œæœˆå…‰ä»ç ´ç¢çš„ç©¹é¡¶æ´’ä¸‹...', [
        {text:'å‘æœˆç¥ç¥ˆç¥·ï¼ˆæ”¹å˜æœˆç›¸ï¼Œè·å¾—æœˆç¥ç¥ç¦é—ç‰©ï¼‰', on(){ 
          changeMoonPhase({p:game.player}); 
          game.player.relics.push('moon_blessing'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'çŒ®ç¥­è®°å¿†ï¼ˆå¤±å»1ä¸ªæŠ€èƒ½ï¼Œ+2èƒ½é‡ä¸Šé™ï¼‰', on(){ 
          if(game.player.skills.length > 1) {
            const idx = rng.int(0, game.player.skills.length-1);
            game.player.skills.splice(idx, 1);
            game.player.maxEnergy += 2;
            addLog('çŒ®ç¥­äº†è®°å¿†ï¼Œè·å¾—æ›´å¤šèƒ½é‡');
          }
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€ç¥æ®¿ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // ç ´ç¢çš„é•œå­äº‹ä»¶ï¼ˆAve Mujicaä¸»é¢˜ï¼‰
      () => setStory('ç ´ç¢çš„é•œå­åå°„ç€äº”ä¸ªä¸åŒçš„é¢å…·...', [
        {text:'å‡è§†Timorisçš„ææƒ§ï¼ˆ+2ç‹‚æ°”ï¼Œè·å¾—TimorisæŠ€èƒ½ï¼‰', on(){ 
          game.player.madness += 2; 
          const fearSkills = SKILL_DB.filter(s => s.mask === 'timoris' && !game.player.skills.includes(s.id));
          if(fearSkills.length > 0) {
            game.player.skills.push(fearSkills[0].id);
          }
          renderHUD(); toNextFloor(); 
        }},
        {text:'è§¦æ‘¸é•œç‰‡ï¼ˆ-8ç”Ÿå‘½ï¼Œè·å¾—é•œç‰‡ç¢ç‰‡é—ç‰©ï¼‰', on(){ 
          game.player.hp -= 8; 
          game.player.relics.push('mirror_fragment'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'ç»•è¿‡é•œå­ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // è¡€ä¹‹å¥‘çº¦äº‹ä»¶
      () => setStory('å¤è€çš„è¡€ä¹‹å¥‘çº¦ä¹¦åœ¨æœˆå…‰ä¸‹å‘å‡ºçº¢å…‰...', [
        {text:'ç­¾ç½²å¥‘çº¦ï¼ˆ+1å •è½åº¦ï¼Œè·å¾—è¡€ä¹‹å¥‘çº¦é—ç‰©ï¼‰', on(){ 
          increaseCorruption({p:game.player}); 
          game.player.relics.push('blood_pact'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'ç”¨è¡€å¼ºåŒ–é¢å…·ï¼ˆ-5ç”Ÿå‘½ï¼Œé¢å…·æŠ€èƒ½å¢å¼º3å›åˆï¼‰', on(){ 
          game.player.enhancedTurns += 3; 
          game.player.hp -= 5;
          addLog('é¢å…·æŠ€èƒ½åœ¨3å›åˆå†…å¢å¼º'); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'æ‹’ç»å¥‘çº¦ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // è¿·å¤±çš„æœ¨å¶äº‹ä»¶
      () => setStory('ä¸€ä¸ªç ´ç¢çš„æœ¨å¶èººåœ¨åœ°ä¸Šï¼šã€Œæˆ‘æ›¾ç»ä¹Ÿæœ‰æ¢¦æƒ³...ã€', [
        {text:'ä¿®å¤æœ¨å¶ï¼ˆè·å¾—å¬å”¤æŠ€èƒ½ï¼Œè·å¾—æœ¨å¶ä¹‹é­‚é—ç‰©ï¼‰', on(){ 
          const puppetSkills = SKILL_DB.filter(s => s.type === 'summon' && !game.player.skills.includes(s.id));
          if(puppetSkills.length > 0) {
            game.player.skills.push(puppetSkills[0].id);
          }
          game.player.relics.push('puppet_soul');
          renderRelics(); toNextFloor(); 
        }},
        {text:'å¸æ”¶æœ¨å¶çš„è®°å¿†ï¼ˆ+1ç‹‚æ°”ï¼Œ+15ç”Ÿå‘½ï¼‰', on(){ 
          game.player.madness++; 
          heal({p:game.player}, 15); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'å¿½è§†æœ¨å¶ï¼ˆæ— æ•ˆæœï¼‰', on(){ toNextFloor(); }}
      ]),
      
      // ç¦å¿Œå›¾ä¹¦é¦†äº‹ä»¶
      () => setStory('Ave Mujicaçš„ç¦å¿Œå›¾ä¹¦é¦†ï¼Œä¹¦æ¶ä¸Šæ‘†æ»¡äº†å±é™©çš„çŸ¥è¯†...', [
        {text:'é˜…è¯»ã€Šé¢å…·çš„çœŸç›¸ã€‹ï¼ˆ+3ç‹‚æ°”ï¼Œè§£é”é¢å…·åˆ‡æ¢ï¼‰', on(){ 
          game.player.madness += 3; 
          const maskSkills = SKILL_DB.filter(s => s.id === 'maskShift' && !game.player.skills.includes(s.id));
          if(maskSkills.length > 0) {
            game.player.skills.push(maskSkills[0].id);
          }
          renderHUD(); toNextFloor(); 
        }},
        {text:'é˜…è¯»ã€Šæœˆç›¸ç§˜å…¸ã€‹ï¼ˆå­¦ä¹ æœˆç›¸æŠ€èƒ½ï¼‰', on(){ 
          const moonSkills = SKILL_DB.filter(s => s.type === 'moon' && !game.player.skills.includes(s.id));
          if(moonSkills.length > 0) {
            game.player.skills.push(moonSkills[0].id);
          }
          toNextFloor(); 
        }},
        {text:'é˜…è¯»ã€Šæ²»æ„ˆä¹‹æ­Œã€‹ï¼ˆ+20ç”Ÿå‘½ï¼‰', on(){ 
          heal({p:game.player}, 20); 
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€å›¾ä¹¦é¦†', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('è¯¡å¼‚çš„é›•åƒï¼šå®ƒçš„çœ¼ç›ä¼¼ä¹åœ¨æ³¨è§†ç€ä½ ã€‚', [
        {text:'è§¦æ‘¸é›•åƒï¼ˆéšæœºæ•ˆæœï¼‰', on(){ 
          const effect = rng.int(0, 2);
          if(effect === 0) { heal({p:game.player}, 25); }
          else if(effect === 1) { game.player.hp -= 15; }
          else { game.player.relics.push('statue_blessing'); renderRelics(); }
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç ´åé›•åƒï¼ˆè·å¾—çŸ³å—é—ç‰©ï¼‰', on(){ game.player.relics.push('stone_chunk'); renderRelics(); toNextFloor(); }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('æœˆå…‰æ³‰æ°´ï¼šæ¸…æ¾ˆçš„æ³‰æ°´åå°„ç€æœˆå…‰ã€‚', [
        {text:'é¥®ç”¨æ³‰æ°´ï¼ˆå®Œå…¨æ¢å¤ç”Ÿå‘½ï¼‰', on(){ game.player.hp = game.player.maxHp; renderHUD(); toNextFloor(); }},
        {text:'ç”¨æ³‰æ°´å‡€åŒ–ï¼ˆç§»é™¤æ‰€æœ‰è¯…å’’ï¼‰', on(){ game.player.curse = 0; renderHUD(); toNextFloor(); }},
        {text:'æ”¶é›†æ³‰æ°´ï¼ˆè·å¾—æ²»ç–—è¯æ°´é—ç‰©ï¼‰', on(){ game.player.relics.push('healing_potion'); renderRelics(); toNextFloor(); }}
      ]),
      
      () => setStory('æˆ˜å£«çš„å¢“ç¢‘ï¼šä¸€ä½è‹±å‹‡æˆ˜å£«çš„æœ€åå®‰æ¯åœ°ã€‚', [
        {text:'ç¥­æ‹œï¼ˆè·å¾—æˆ˜å£«ä¹‹é­‚é—ç‰©ï¼‰', on(){ game.player.relics.push('warrior_soul'); renderRelics(); toNextFloor(); }},
        {text:'æŒ–æ˜å¢“ç©´ï¼ˆ+1è¯…å’’ï¼Œè·å¾—å¤è€æ­¦å™¨ï¼‰', on(){ 
          game.player.curse++; 
          game.player.relics.push('ancient_weapon'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('ç¥ç§˜çš„ä¼ é€é—¨ï¼šé€šå‘æœªçŸ¥çš„åœ°æ–¹ã€‚', [
        {text:'è¿›å…¥ä¼ é€é—¨ï¼ˆè·³è¿‡2å±‚ï¼Œä½†å—åˆ°ä¼¤å®³ï¼‰', on(){ 
          game.player.hp -= 20; 
          game.floor += 2; 
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç ”ç©¶ä¼ é€é—¨ï¼ˆå­¦ä¹ ä¼ é€æŠ€èƒ½ï¼‰', on(){ 
          const teleportSkill = SKILL_DB.find(s => s.id === 'teleport');
          if(teleportSkill && !game.player.skills.includes('teleport')) {
            game.player.skills.push('teleport');
          }
          toNextFloor(); 
        }},
        {text:'ç»•è¿‡', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('é­”æ³•æ°´æ™¶ï¼šè•´å«ç€çº¯å‡€çš„èƒ½é‡ã€‚', [
        {text:'å¸æ”¶èƒ½é‡ï¼ˆæ°¸ä¹…+1èƒ½é‡ï¼‰', on(){ 
          game.player.maxEnergy = (game.player.maxEnergy || 3) + 1; 
          renderHUD(); toNextFloor(); 
        }},
        {text:'ç²‰ç¢æ°´æ™¶ï¼ˆè·å¾—æ°´æ™¶ç¢ç‰‡é—ç‰©ï¼‰', on(){ 
          game.player.relics.push('crystal_shard'); 
          renderRelics(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('å¤è€çš„é”»é€ å°ï¼šè¿˜åœ¨æ•£å‘ç€ä½™æ¸©ã€‚', [
        {text:'é”»é€ æ­¦å™¨ï¼ˆ-10ç”Ÿå‘½ï¼Œæ‰€æœ‰æ”»å‡»+3ä¼¤å®³ï¼‰', on(){ 
          game.player.hp -= 10; 
          game.player.relics.push('forged_weapon'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'é”»é€ æŠ¤ç”²ï¼ˆ-5ç”Ÿå‘½ï¼Œæ¯å›åˆ+2æ ¼æŒ¡ï¼‰', on(){ 
          game.player.hp -= 5; 
          game.player.relics.push('forged_armor'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('è¯…å’’çš„å®ç®±ï¼šæ•£å‘ç€ä¸ç¥¥çš„æ°”æ¯ã€‚', [
        {text:'å¼ºè¡Œæ‰“å¼€ï¼ˆ+2è¯…å’’ï¼Œè·å¾—å¼ºåŠ›é—ç‰©ï¼‰', on(){ 
          game.player.curse += 2; 
          game.player.relics.push('cursed_treasure'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'å°å¿ƒæ‰“å¼€ï¼ˆ+1è¯…å’’ï¼Œå­¦ä¹ æ–°æŠ€èƒ½ï¼‰', on(){ 
          game.player.curse++; 
          offerSkills(); 
        }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('æ—¶é—´è£‚ç¼ï¼šæ—¶ç©ºåœ¨æ­¤å¤„æ‰­æ›²ã€‚', [
        {text:'è¿›å…¥è£‚ç¼ï¼ˆé‡ç½®æ‰€æœ‰æŠ€èƒ½å†·å´ï¼‰', on(){ 
          game.player.skillCooldowns = {}; 
          game.player.skillUses = {}; 
          toNextFloor(); 
        }},
        {text:'è§‚å¯Ÿè£‚ç¼ï¼ˆè·å¾—æ—¶é—´é—ç‰©ï¼‰', on(){ 
          game.player.relics.push('time_shard'); 
          renderRelics(); toNextFloor(); 
        }},
        {text:'è¿œç¦»', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('ç–¯ç‹‚çš„å­¦è€…ï¼šã€ŒçœŸç†å°±åœ¨çœ¼å‰ï¼ã€', [
        {text:'å¬å–æ•™å¯¼ï¼ˆ+3ç‹‚æ°”ï¼Œå­¦ä¹ 2ä¸ªæŠ€èƒ½ï¼‰', on(){ 
          game.player.madness += 3; 
          offerSkills(); 
          // å»¶è¿Ÿç¬¬äºŒæ¬¡æŠ€èƒ½é€‰æ‹©
          setTimeout(() => offerSkills(), 100);
        }},
        {text:'å®‰æŠšå­¦è€…ï¼ˆ-1ç‹‚æ°”ï¼Œè·å¾—æ™ºæ…§é—ç‰©ï¼‰', on(){ 
          if(game.player.madness > 0) game.player.madness--; 
          game.player.relics.push('scholar_wisdom'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'é€ƒç¦»', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('æœˆç›¸ç¥­å›ï¼šå¯ä»¥æ”¹å˜æœˆç›¸çš„ç¥ç§˜ç¥­å›ã€‚', [
        {text:'æ”¹å˜ä¸ºæ–°æœˆï¼ˆé‡ç½®ç‹‚æ°”å’Œè¯…å’’ï¼‰', on(){ 
          game.moonPhase = 0; 
          game.player.madness = 0; 
          game.player.curse = 0; 
          renderHUD(); toNextFloor(); 
        }},
        {text:'æ”¹å˜ä¸ºæ»¡æœˆï¼ˆ+2ç‹‚æ°”ï¼Œæ”»å‡»åŠ›ç¿»å€ï¼‰', on(){ 
          game.moonPhase = 3; 
          game.player.madness += 2; 
          game.player.relics.push('moon_blessing'); 
          renderHUD(); renderRelics(); toNextFloor(); 
        }},
        {text:'ç¦»å¼€', on(){ toNextFloor(); }}
      ]),
      
      () => setStory('ç¥ç§˜çš„é¢å…·å•†äººï¼šã€Œé€‰æ‹©ä½ çš„æ–°é¢å­”...ã€', [
        {text:'æˆ˜å£«é¢å…·ï¼ˆ+10æœ€å¤§ç”Ÿå‘½ï¼Œå­¦ä¹ æ”»å‡»æŠ€èƒ½ï¼‰', on(){ 
          game.player.maxHp += 10; 
          game.player.hp += 10; 
          const attackSkills = SKILL_DB.filter(s => s.type === 'attack' && !game.player.skills.includes(s.id));
          if(attackSkills.length > 0) {
            game.player.skills.push(attackSkills[0].id);
          }
          renderHUD(); toNextFloor(); 
        }},
        {text:'æ³•å¸ˆé¢å…·ï¼ˆ+1èƒ½é‡ï¼Œå­¦ä¹ é­”æ³•æŠ€èƒ½ï¼‰', on(){ 
          game.player.maxEnergy = (game.player.maxEnergy || 3) + 1; 
          const magicSkills = SKILL_DB.filter(s => s.type === 'magic' && !game.player.skills.includes(s.id));
          if(magicSkills.length > 0) {
            game.player.skills.push(magicSkills[0].id);
          }
          renderHUD(); toNextFloor(); 
        }},
        {text:'æ‹’ç»', on(){ toNextFloor(); }}
      ])
    ];
    
    const event = events[rng.int(0, events.length - 1)];
    event();
  }
  function campfire(){ setStory('æœˆå…‰è¥ç«ï¼šåœ¨è¿™é‡Œä½ å¯ä»¥è†å¬å†…å¿ƒçš„å£°éŸ³...', [
    {text:'ä¼‘æ¯ï¼ˆ+20ç”Ÿå‘½ï¼‰', on(){ heal({p:game.player},20); renderHUD(); toNextFloor(); }},
    {text:'é¢å…·å†¥æƒ³ï¼ˆå­¦ä¹ æ–°æŠ€èƒ½ï¼‰', on(){ offerSkills(); }},
    {text:'ç‹‚æ°”ä¿®ç‚¼ï¼ˆ+1ç‹‚æ°”ï¼Œ+5æœ€å¤§ç”Ÿå‘½ï¼‰', on(){ 
      game.player.madness++; 
      game.player.maxHp += 5;
      game.player.hp += 5;
      game.player.relics.push('madness_sigil'); 
      renderHUD(); renderRelics(); toNextFloor(); 
    }},
    {text:'æœˆç›¸è§‚æµ‹ï¼ˆæ”¹å˜æœˆç›¸ï¼Œ+1èƒ½é‡ï¼‰', on(){ 
      changeMoonPhase({p:game.player}); 
      game.player.energy++;
      renderHUD(); toNextFloor(); 
    }},
    {text:'æ·±åº¦å†¥æƒ³ï¼ˆ+1æœ€å¤§èƒ½é‡ï¼Œ+1å •è½åº¦ï¼‰', on(){ 
      game.player.maxEnergy++; 
      increaseCorruption({p:game.player}); 
      renderHUD(); toNextFloor(); 
    }}
  ]); }

  // ===== å¼€åœºå‰§æƒ…ä¸ç»“å±€ =====
  function startIntro(){
    // ç›´æ¥è®¾ç½®Dolorisä¸ºé»˜è®¤è§’è‰²
    game.player.name = 'Doloris';
    game.player.currentMask = 'doloris';
    game.player.skills = getBaseSkills();
    game.player.madness = 0;
    game.player.corruption = 0;
    game.player.maxEnergy = 4;
    
    // ç›´æ¥å¼€å§‹Dolorisçš„ä¸“å±å¼€åœºæ•…äº‹
    startDirectJourney();
  }
  
  function startDirectJourney() {
    // åŸºäºèƒŒæ™¯æ•…äº‹ï¼ŒDolorisæ˜¯Ave Mujicaçš„æ ¸å¿ƒäººç‰©ï¼Œç›´æ¥å¼€å§‹å¥¹çš„æ•…äº‹
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: var(--gold);">Doloris - ç—›è‹¦ä¹‹é¢</h3>
      </div>
      
      <p style="line-height: 1.6; color: var(--ink);">
        åœ¨æœˆå…‰çš„è§è¯ä¸‹ï¼Œä½ å·²ç»æˆ´ä¸Šäº†ç—›è‹¦ä¹‹é¢ã€‚è¿™ä¸æ˜¯é€‰æ‹©ï¼Œè€Œæ˜¯å‘½è¿ã€‚
        Dolorisçš„åŠ›é‡åœ¨ä½ ä½“å†…è§‰é†’ï¼Œç—›è‹¦ä¸åŠ›é‡äº¤ç»‡ï¼Œæˆä¸ºä½ å‰è¡Œçš„åŠ¨åŠ›ã€‚
      </p>
      
      <div style="background: var(--bg); border: 1px solid var(--gold); padding: 15px; border-radius: 6px; margin: 15px 0;">
        <p style="color: var(--gold); font-weight: bold; margin-bottom: 8px;">
          Dolorisçš„ä½è¯­ï¼š
        </p>
        <p style="color: var(--ink); font-style: italic;">
          "ç—›è‹¦æ˜¯æˆ‘çš„åå­—ï¼Œä¹Ÿæ˜¯æˆ‘çš„åŠ›é‡ã€‚åœ¨é»‘æš—ä¸­ï¼Œæˆ‘å°†æ•™ä¼šä½ å¦‚ä½•å°†ç—›è‹¦è½¬åŒ–ä¸ºåŠ›é‡ï¼Œ
          å°†ç»æœ›åŒ–ä½œå¸Œæœ›ã€‚ä½†è®°ä½ï¼Œæ¯ä¸€æ¬¡ä½¿ç”¨æˆ‘çš„åŠ›é‡ï¼Œä½ éƒ½å°†æ‰¿å—ç›¸åº”çš„ç—›è‹¦..."
        </p>
      </div>
      
      <p style="line-height: 1.6; color: var(--ink);">
        ç¥æ®¿å¼€å§‹éœ‡åŠ¨ï¼Œå¤è€çš„æœºå…³è¢«æ¿€æ´»ã€‚ä¸€é“å…‰é—¨åœ¨ä½ é¢å‰ç¼“ç¼“æ‰“å¼€ï¼Œ
        é€šå‘Ave Mujicaè¯•ç‚¼çš„æ·±æ¸Šã€‚ä½ æ„Ÿå—åˆ°äº†å‰æ‰€æœªæœ‰çš„åŠ›é‡ï¼Œ
        ä½†åŒæ—¶ä¹Ÿæ„è¯†åˆ°è¿™ä»½åŠ›é‡èƒŒåéšè—ç€å·¨å¤§çš„ä»£ä»·...
      </p>
      
      <div style="background: var(--panel); border: 1px solid var(--accent); padding: 15px; border-radius: 6px; margin: 15px 0;">
        <strong style="color: var(--accent);">ç³»ç»Ÿæç¤ºï¼š</strong><br>
        â€¢ ç‹‚æ°”å€¼ä¼šå½±å“ä½ çš„åˆ¤æ–­å’Œå¯¹è¯é€‰æ‹©<br>
        â€¢ å •è½åº¦ä¼šæ”¹å˜æ•…äº‹çš„èµ°å‘å’Œç»“å±€<br>
        â€¢ æœˆç›¸ä¼šå½±å“æŠ€èƒ½æ•ˆæœå’Œé­é‡çš„äº‹ä»¶<br>
        â€¢ æ¯ä¸ªé€‰æ‹©éƒ½æœ‰å…¶ä»£ä»·ï¼Œè¯·è°¨æ…å†³å®š
      </div>
    `, [
      {text: 'è¸å…¥å…‰é—¨ï¼Œå¼€å§‹Ave Mujicaçš„è¯•ç‚¼', on() { 
        game.state='map'; 
        renderHUD(); 
        renderMap(); 
        updateCharacterPortrait();
      }}
    ]);
  }
  
  function showIntroSequence() {
    setStory(`
      <div style="text-align: center; font-style: italic; color: #8B4B8C; margin-bottom: 20px;">
        ã€Œåœ¨æœˆå…‰çš„è§è¯ä¸‹ï¼Œäº”ä¸ªé¢å…·é™é™åœ°èººåœ¨å¤è€çš„ç¥­å›ä¸Š...ã€
      </div>
      
      <p style="line-height: 1.6;">
        è¿™é‡Œæ˜¯è¢«é—å¿˜çš„ç¥æ®¿ï¼Œæœˆå…‰é€è¿‡ç ´ç¢çš„å½©è‰²ç»ç’ƒæ´’åœ¨åœ°é¢ä¸Šï¼Œå½¢æˆæ–‘é©³çš„å…‰å½±ã€‚
        ç©ºæ°”ä¸­å¼¥æ¼«ç€å¤è€çš„é¦™æ°”ï¼Œä»¿ä½›æ—¶é—´åœ¨è¿™é‡Œåœæ»äº†åƒå¹´ã€‚
      </p>
      
      <p style="line-height: 1.6; color: #A0A0A0;">
        ä½ æ„Ÿå—åˆ°ä¸€ç§è«åçš„å¬å”¤ï¼Œè„šæ­¥ä¸ç”±è‡ªä¸»åœ°å‘ç¥­å›èµ°å»ã€‚
        äº”ä¸ªé¢å…·ï¼Œæ¯ä¸€ä¸ªéƒ½æ•£å‘ç€ä¸åŒçš„æ°”æ¯ï¼Œè¯‰è¯´ç€ä¸åŒçš„æ•…äº‹...
      </p>
    `, [
      {text: 'èµ°å‘ç¥­å›', on() { showMaskSelection(); }}
    ]);
  }
  
  function showMaskSelection() {
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: #8B4B8C;">é€‰æ‹©ä½ çš„å‘½è¿é¢å…·</h3>
      </div>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #8B4B8C;">Doloris - ç—›è‹¦ä¹‹é¢</strong><br>
        <em style="color: #A0A0A0;">ã€Œç—›è‹¦æ˜¯æˆé•¿çš„ä»£ä»·ï¼Œä¹Ÿæ˜¯åŠ›é‡çš„æºæ³‰...ã€</em><br>
        æ“…é•¿æš—å½±æ”»å‡»å’Œé¢å…·è½¬æ¢ï¼Œåœ¨ç—›è‹¦ä¸­å¯»æ‰¾åŠ›é‡ã€‚
      </div>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #8B4B8C;">Mortis - æ­»äº¡ä¹‹é¢</strong><br>
        <em style="color: #A0A0A0;">ã€Œæ­»äº¡å¹¶éç»ˆç»“ï¼Œè€Œæ˜¯å¦ä¸€ç§å¼€å§‹...ã€</em><br>
        æŒæ§ç”Ÿæ­»ä¹‹åŠ›ï¼Œèƒ½å¤Ÿæ±²å–ç”Ÿå‘½å’Œæ“æ§è¡€æ¶²ã€‚
      </div>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #8B4B8C;">Amoris - çˆ±æ‹ä¹‹é¢</strong><br>
        <em style="color: #A0A0A0;">ã€Œçˆ±æ˜¯æœ€ç¾çš„æ¯’è¯ï¼Œä¹Ÿæ˜¯æœ€æ·±çš„è¯…å’’...ã€</em><br>
        ä»¥çˆ±ä¹‹åæ–½å±•é­…æƒ‘å’Œæ²»æ„ˆï¼Œåœ¨æ¸©æŸ”ä¸­éšè—é”‹èŠ’ã€‚
      </div>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #8B4B8C;">Timoris - ææƒ§ä¹‹é¢</strong><br>
        <em style="color: #A0A0A0;">ã€Œææƒ§æ˜¯å¿ƒçµçš„æ·é”ï¼Œä¹Ÿæ˜¯ç²¾ç¥çš„æ­¦å™¨...ã€</em><br>
        æ“æ§ææƒ§å’Œå™©æ¢¦ï¼Œåœ¨ç‹‚æ°”ä¸­é‡Šæ”¾çœŸæ­£çš„åŠ›é‡ã€‚
      </div>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #8B4B8C;">Oblivionis - é—å¿˜ä¹‹é¢</strong><br>
        <em style="color: #A0A0A0;">ã€Œé—å¿˜æ˜¯è§£è„±ï¼Œä¹Ÿæ˜¯æ–°ç”Ÿçš„å¼€å§‹...ã€</em><br>
        æŒæ¡è™šæ— ä¹‹åŠ›ï¼Œèƒ½å¤ŸæŠ¹é™¤è®°å¿†å’Œå­˜åœ¨æœ¬èº«ã€‚
      </div>
    `, [
      {text: 'é€‰æ‹© Dolorisï¼ˆç—›è‹¦ä¹‹é¢ï¼‰', on() { selectMask('doloris'); }},
      {text: 'é€‰æ‹© Mortisï¼ˆæ­»äº¡ä¹‹é¢ï¼‰', on() { selectMask('mortis'); }},
      {text: 'é€‰æ‹© Amorisï¼ˆçˆ±æ‹ä¹‹é¢ï¼‰', on() { selectMask('amoris'); }},
      {text: 'é€‰æ‹© Timorisï¼ˆææƒ§ä¹‹é¢ï¼‰', on() { selectMask('timoris'); }},
      {text: 'é€‰æ‹© Oblivionisï¼ˆé—å¿˜ä¹‹é¢ï¼‰', on() { selectMask('oblivionis'); }}
    ]);
  }
  
  function selectMask(maskId) {
    game.player.currentMask = maskId;
    const mask = MASKS[maskId];
    
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: ${mask.color};">ä½ é€‰æ‹©äº† ${mask.name}</h3>
      </div>
      
      <p style="line-height: 1.6;">
        å½“ä½ çš„æ‰‹è§¦ç¢°åˆ°é¢å…·çš„ç¬é—´ï¼Œä¸€è‚¡å¼ºçƒˆçš„åŠ›é‡æ¶Œå…¥ä½ çš„èº«ä½“ã€‚
        é¢å…·ä»¿ä½›æ´»äº†è¿‡æ¥ï¼Œä¸ä½ çš„çµé­‚äº§ç”Ÿäº†å…±é¸£...
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <em style="color: ${mask.color};">${getMaskMonologue(maskId)}</em>
      </div>
      
      <p style="line-height: 1.6; color: #A0A0A0;">
        é¢å…·ç¼“ç¼“èå…¥ä½ çš„è„¸åºï¼Œä½ æ„Ÿå—åˆ°äº†å‰æ‰€æœªæœ‰çš„åŠ›é‡ã€‚
        ä½†åŒæ—¶ï¼Œä½ ä¹Ÿæ„è¯†åˆ°è¿™ä»½åŠ›é‡èƒŒåéšè—ç€å·¨å¤§çš„ä»£ä»·...
      </p>
      
      <p style="line-height: 1.6;">
        ç¥æ®¿å¼€å§‹éœ‡åŠ¨ï¼Œå¤è€çš„æœºå…³è¢«æ¿€æ´»ã€‚
        ä¸€é“å…‰é—¨åœ¨ä½ é¢å‰ç¼“ç¼“æ‰“å¼€ï¼Œé€šå‘æœªçŸ¥çš„æ·±æ¸Š...
      </p>
    `, [
      {text: 'è¸å…¥å…‰é—¨ï¼Œå¼€å§‹æ—…ç¨‹', on() { startJourney(); }}
    ]);
  }
  
  function getMaskMonologue(maskId) {
    const monologues = {
      'doloris': 'ã€Œç—›è‹¦æ˜¯æˆ‘çš„åå­—ï¼Œä¹Ÿæ˜¯æˆ‘çš„åŠ›é‡ã€‚åœ¨é»‘æš—ä¸­ï¼Œæˆ‘å°†æ•™ä¼šä½ å¦‚ä½•å°†ç—›è‹¦è½¬åŒ–ä¸ºåŠ›é‡ï¼Œå°†ç»æœ›åŒ–ä½œå¸Œæœ›ã€‚ä½†è®°ä½ï¼Œæ¯ä¸€æ¬¡ä½¿ç”¨æˆ‘çš„åŠ›é‡ï¼Œä½ éƒ½å°†æ‰¿å—ç›¸åº”çš„ç—›è‹¦...ã€',
      'mortis': 'ã€Œæ­»äº¡å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯å¯¹æ­»äº¡çš„ææƒ§ã€‚æˆ‘å°†èµäºˆä½ æ“æ§ç”Ÿæ­»çš„åŠ›é‡ï¼Œè®©ä½ åœ¨ç”Ÿä¸æ­»çš„è¾¹ç¼˜æ¸¸èµ°ã€‚ä½†è¦å°å¿ƒï¼Œå‡è§†æ·±æ¸Šçš„äººï¼Œæ·±æ¸Šä¹Ÿåœ¨å‡è§†ç€ä½ ...ã€',
      'amoris': 'ã€Œçˆ±æ˜¯ä¸–é—´æœ€ç¾å¥½çš„æƒ…æ„Ÿï¼Œä¹Ÿæ˜¯æœ€å±é™©çš„æ¯’è¯ã€‚æˆ‘å°†æ•™ä¼šä½ å¦‚ä½•ç”¨çˆ±æ¥æ²»æ„ˆï¼Œä¹Ÿå¦‚ä½•ç”¨çˆ±æ¥æ¯ç­ã€‚ä½†è¯·è®°ä½ï¼Œçˆ±å¾—è¶Šæ·±ï¼Œå¤±å»æ—¶çš„ç—›è‹¦å°±è¶Šå¤§...ã€',
      'timoris': 'ã€Œææƒ§æ˜¯äººç±»æœ€åŸå§‹çš„æƒ…æ„Ÿï¼Œä¹Ÿæ˜¯æœ€å¼ºå¤§çš„æ­¦å™¨ã€‚æˆ‘å°†è®©ä½ æŒæ§ææƒ§ï¼Œåœ¨å™©æ¢¦ä¸­å¯»æ‰¾åŠ›é‡ã€‚ä½†å½“ä½ å‡è§†ææƒ§æ—¶ï¼Œææƒ§ä¹Ÿåœ¨æ”¹å˜ç€ä½ ...ã€',
      'oblivionis': 'ã€Œé—å¿˜æ˜¯è§£è„±ï¼Œä¹Ÿæ˜¯æ–°ç”Ÿã€‚æˆ‘å°†æ•™ä¼šä½ å¦‚ä½•æŠ¹é™¤ç—›è‹¦çš„è®°å¿†ï¼Œä¹Ÿå¦‚ä½•è®©æ•Œäººå¿˜è®°å­˜åœ¨çš„æ„ä¹‰ã€‚ä½†è¦è®°ä½ï¼Œé—å¿˜ä»–äººçš„åŒæ—¶ï¼Œä½ ä¹Ÿåœ¨é—å¿˜è‡ªå·±...ã€'
    };
    return monologues[maskId] || '';
  }
  
  function startJourney() {
    setStory(`
      <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: #8B4B8C;">Ave Mujica çš„è¯•ç‚¼å¼€å§‹</h3>
      </div>
      
      <p style="line-height: 1.6;">
        å…‰é—¨çš„å¦ä¸€è¾¹æ˜¯ä¸€ä¸ªæ‰­æ›²çš„ä¸–ç•Œï¼Œè¿™é‡Œçš„ä¸€åˆ‡éƒ½è¢«æœˆå…‰æŸ“æˆäº†é“¶ç™½è‰²ã€‚
        è¿œå¤„ä¼ æ¥è‹¥æœ‰è‹¥æ— çš„éŸ³ä¹å£°ï¼Œé‚£æ˜¯Ave Mujicaæ°¸æ’çš„æ—‹å¾‹...
      </p>
      
      <p style="line-height: 1.6; color: #A0A0A0;">
        ä½ æ„è¯†åˆ°è¿™ä¸æ˜¯ä¸€åœºæ™®é€šçš„å†’é™©ï¼Œè€Œæ˜¯ä¸€æ¬¡çµé­‚çš„è¯•ç‚¼ã€‚
        åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œä½ å°†é¢å¯¹è‡ªå·±å†…å¿ƒæœ€æ·±å¤„çš„ææƒ§ã€æ¬²æœ›å’Œç§˜å¯†ã€‚
      </p>
      
      <div style="background: rgba(139, 75, 140, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <strong style="color: #8B4B8C;">ç³»ç»Ÿæç¤ºï¼š</strong><br>
        â€¢ ç‹‚æ°”å€¼ä¼šå½±å“ä½ çš„åˆ¤æ–­å’Œå¯¹è¯é€‰æ‹©<br>
        â€¢ å •è½åº¦ä¼šæ”¹å˜æ•…äº‹çš„èµ°å‘å’Œç»“å±€<br>
        â€¢ æœˆç›¸ä¼šå½±å“æŠ€èƒ½æ•ˆæœå’Œé­é‡çš„äº‹ä»¶<br>
        â€¢ æ¯ä¸ªé€‰æ‹©éƒ½æœ‰å…¶ä»£ä»·ï¼Œè¯·è°¨æ…å†³å®š
      </div>
      
      <p style="line-height: 1.6;">
        å‰æ–¹çš„é“è·¯åˆ†ä¸ºå‡ æ¡ï¼Œæ¯ä¸€æ¡éƒ½é€šå‘ä¸åŒçš„å‘½è¿...
      </p>
    `, [
      {text: 'è¸ä¸Šå‘½è¿ä¹‹è·¯', on() { game.state='map'; renderHUD(); renderMap(); }}
    ]);
  }
  function resolveEnding(){ 
    const p = game.player; 
    const madness = p.madness; 
    const corruption = p.corruption;
    let end;
    
    if(game.bossDefeated && madness <= 2 && corruption === 0) {
      end = 'çº¯æ´ç»ˆç« ï¼šä½ ä¿æŒäº†å†…å¿ƒçš„çº¯å‡€ï¼Œé¢å…·ä¸çœŸæˆ‘å®Œç¾èåˆã€‚Ave Mujicaçš„çœŸè°›åœ¨ä½ å¿ƒä¸­ç»½æ”¾ã€‚';
    } else if(game.bossDefeated && madness <= 5 && corruption <= 2) {
      end = 'å¹³è¡¡ä¹‹æ­Œï¼šåœ¨ç‹‚æ°”ä¸ç†æ™ºä¹‹é—´æ‰¾åˆ°äº†å¹³è¡¡ï¼Œä½ æˆä¸ºäº†çœŸæ­£çš„Ave Mujicaæˆå‘˜ã€‚';
    } else if(game.bossDefeated && corruption >= 4) {
      end = 'å •è½å¥³ç‹ï¼šä½ æ‹¥æŠ±äº†é»‘æš—ï¼Œæˆä¸ºäº†Ave Mujicaä¼ è¯´ä¸­çš„å •è½å¥³ç‹ï¼Œç»Ÿæ²»ç€æœˆå¤œçš„ä¸–ç•Œã€‚';
    } else if(game.bossDefeated && madness >= 8) {
      end = 'ç‹‚æ°”è¯—äººï¼šç–¯ç‹‚æˆä¸ºäº†ä½ çš„åŠ›é‡ï¼Œä½ çš„æ­Œå£°å°†æ°¸è¿œå›å“åœ¨Ave Mujicaçš„æ®¿å ‚ä¸­ã€‚';
    } else if(!game.bossDefeated) {
      end = 'æœªå®Œæˆçš„ä¹ç« ï¼šé¢å…·çš„ç§˜å¯†ä»ç„¶éšè—åœ¨é»‘æš—ä¸­ï¼Œç­‰å¾…ç€ä¸‹ä¸€ä¸ªå‹‡æ•¢çš„çµé­‚ã€‚';
    } else {
      end = 'æœˆèš€ç»ˆå¹•ï¼šä½ åœ¨å…‰æ˜ä¸é»‘æš—ä¹‹é—´å¾˜å¾Šï¼Œæˆä¸ºäº†Ave Mujicaæ°¸æ’çš„ä¼ è¯´ã€‚';
    }
    
    setStory(end + '<br><br>Ave Mujicaçš„æ•…äº‹æ°¸ä¸è½å¹•...', [{text:'é‡æ–°å¼€å§‹æ—…ç¨‹', on(){ location.reload(); }}]);
  }

  // ===== è§†æ•ˆï¼šè¡€æœˆé—ªçƒ & åˆæˆå‰¯æ­Œ =====
  function bloodMoonFlash(){ const bm = el('#bloodmoon'); bm.style.transform='scale(1.06)'; bm.style.boxShadow='0 0 18px 4px rgba(177,18,38,.9)'; setTimeout(()=>{ bm.style.transform=''; bm.style.boxShadow=''; }, 140); }
  function playFinalChorus(){
    // WebAudio åˆæˆ 30s ç‰‡æ®µï¼Œé¿å…ç‰ˆæƒç´ æ
    try {
      const actx = new (window.AudioContext||window.webkitAudioContext)();
      const tempo = 90; const seconds = 30; const notes = [261.63, 329.63, 392.00, 523.25];
      let t = actx.currentTime;
      for(let i=0;i<seconds;i++){
        const n = notes[rng.int(0, notes.length-1)]; const osc = actx.createOscillator(); const g = actx.createGain();
        osc.type='sine'; osc.frequency.value=n; g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.08,t+0.05); g.gain.linearRampToValueAtTime(0.0001,t+0.3);
        osc.connect(g).connect(actx.destination); osc.start(t); osc.stop(t+0.32); t += 0.33;
      }
    } catch(e){ /* å¿½ç•¥éŸ³é¢‘é”™è¯¯ */ }
  }

  // ===== åˆå§‹åŒ– =====
  function init(){ renderRelics(); renderHUD(); renderMap(); updateCharacterPortrait(); updateEnemyPortrait(); startIntro(); }
  init();
  </script>
</body>
</html>